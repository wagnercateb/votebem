<div class="vb-votos-oficiais">
<style>
  /* Scoped styles to ensure identical look across public/admin bases */
  .vb-votos-oficiais .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; }
  .vb-votos-oficiais .card-header { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 10px 15px; }
  .vb-votos-oficiais .card-header .card-title { margin: 0; color: #495057; }
  .vb-votos-oficiais .card-body { padding: 15px; }
  .vb-votos-oficiais .table td, .vb-votos-oficiais .table th { padding: 8px 12px; vertical-align: middle; }
  .vb-votos-oficiais .table tbody tr:hover { background-color: #f1f3f5; }
  .vb-votos-oficiais th[data-field] { cursor: pointer; }
  .vb-votos-oficiais .sort-icon, .vb-votos-oficiais .sort-hint { margin-left: 6px; }
  .vb-votos-oficiais .spin { animation: spin 1s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="card-title mb-0">Votação oficial - Obter votos dos congressistas</h2>
    {% if votacao %}
      <a href="{% url 'voting:votacao_detail' votacao.id %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar à votação
      </a>
    {% endif %}
  </div>
  <div class="card-body">
    {% if votacao %}
<div class="text-muted">Votação: {{ votacao.titulo }} — {{ votacao.proposicao_votacao.proposicao.tipo }} {{ votacao.proposicao_votacao.proposicao.numero }}/{{ votacao.proposicao_votacao.proposicao.ano }}</div>
    {% else %}
      <!-- Form de busca e carregamento (ADMIN)
           - Botão [Carregar]: busca votações via API por Proposição ID e lista resultados filtrados
           - Botão [Carregar votação]: submete "votacao_id" (comportamento original) -->
      <form id="vb-votos-form" method="get" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label for="proposicao_id">Proposição ID:</label>
        <input id="proposicao_id" name="proposicao_id" type="number" min="1" class="form-control" style="max-width:160px;" value="{{ prefill_proposicao_id }}">

        <button id="btn-carregar-proposicao" type="submit" class="btn btn-primary">Carregar</button>

        <label for="votacao_id" style="margin-left:12px;">Votação ID:</label>
        <input id="votacao_id" name="votacao_id" type="text" class="form-control" style="max-width:160px;" placeholder="ex: 2270800-160">
        <button id="btn-carregar-votacao" type="button" class="btn btn-success" style="display:none;">Carregar votação</button>
      </form>
      <div class="form-text" id="vb-votos-hint" aria-live="polite">
        <span id="vb-votos-hint-text">Dica: pesquise por proposição, selecione uma votação e carregue a votação oficial.</span>
        <span id="vb-votos-loading" style="display:none;">
          <i class="bi bi-arrow-repeat spin" aria-hidden="true"></i>
          Carregando votação oficial, aguarde...
        </span>
      </div>
    {% endif %}
  </div>
</div>

{% if not votacao %}
<div class="card" id="vb-votacoes-card" style="display:none;">
  <div class="card-header"><h4 class="card-title">Votações encontradas (turnos / emenda aglutinativa)</h4></div>
  <div class="card-body">
    <div id="vb-votacoes-status" class="text-muted" style="margin-bottom:8px;"></div>
    <div class="table-responsive">
      <table class="table table-sm table-hover" id="vb-votacoes-list" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="padding:6px;">ID</th>
            <th style="padding:6px;">Data/Hora</th>
            <th style="padding:6px;">Descrição</th>
            <th style="padding:6px;">Resultado</th>
            <th style="padding:6px;">Qtd. registros</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card-body" id="vb-votacoes-help" style="display:none;">
    <div class="alert alert-info" style="margin:0;">
      Nenhuma votação correspondente foi encontrada para a proposição informada. Tente outro ID de proposição.
    </div>
  </div>
  <div class="card-body" id="vb-votacoes-error" style="display:none;">
    <div class="alert alert-danger" style="margin:0;">
      Ocorreu um erro ao consultar a API da Câmara. Verifique o ID e tente novamente.
    </div>
  </div>
</div>
{% endif %}


<script>
  const raw = {{ votos_json|default:'[]'|safe }};
  const state = { data: raw, filtered: raw };
  const sortState = {
    partido: { field: null, dir: 'desc' },
    uf: { field: null, dir: 'desc' }
  };

  // --- Busca de votações por Proposição ID na página /gerencial/ (ADMIN) ---
  (function initProposicaoLookup(){
    const form = document.getElementById('vb-votos-form');
    const btnCarregarProposicao = document.getElementById('btn-carregar-proposicao');
    const votacaoInput = document.getElementById('votacao_id');
    const btnCarregarVotacao = document.getElementById('btn-carregar-votacao');
    const propInput = document.getElementById('proposicao_id');
    const card = document.getElementById('vb-votacoes-card');
    const status = document.getElementById('vb-votacoes-status');
    const listTbody = document.querySelector('#vb-votacoes-list tbody');
    const help = document.getElementById('vb-votacoes-help');
    const err = document.getElementById('vb-votacoes-error');
    const hintText = document.getElementById('vb-votos-hint-text');
    const hintLoading = document.getElementById('vb-votos-loading');

    if (!form || !btnCarregarProposicao) return;

    // Prefill votacao_id/consulta_id from URL if present (supports opening the link directly)
    try {
      const params = new URLSearchParams(window.location.search);
      const vParam = params.get('votacao_id') || params.get('consulta_id');
      const pParam = params.get('proposicao_id');
      if (vParam && votacaoInput) {
        votacaoInput.value = vParam;
        btnCarregarVotacao.style.display = 'inline-block';
      }
      if (pParam && propInput) {
        propInput.value = pParam;
      }
    } catch (_) { /* ignore */ }

    // Buscar votações da proposição sem submeter o formulário
    form.addEventListener('submit', function(ev){
      ev.preventDefault();
      const propId = (propInput && propInput.value) ? propInput.value.trim() : '';
      if (!propId) {
        status.textContent = 'Informe o Proposição ID para buscar votações.';
        card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
        listTbody.innerHTML = '';
        return;
      }
      let url = `${window.location.origin}/gerencial/ajax/proposicao-votacoes/?proposicao_id=${encodeURIComponent(propId)}`;
      status.textContent = 'Consultando votações (cache), aguarde...';
      card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
      listTbody.innerHTML = '';

      fetch(url, { headers: { 'Accept': 'application/json' } })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(json => {
          const dados = Array.isArray(json?.dados) ? json.dados : [];
          const needles = [ 'em primeiro turno', 'em segundo turno', 'emenda aglutinativa' ];
          const filtered = dados.filter(item => {
            const d = (item?.descricao || item?.descrição || '').toLowerCase();
            return needles.some(n => d.includes(n));
          });

          if (filtered.length === 0) {
            status.textContent = `Nenhuma votação correspondente para a proposição ${propId}.`;
            help.style.display = 'block'; err.style.display = 'none';
            listTbody.innerHTML = '';
            return;
          }

          status.textContent = `Foram encontradas ${filtered.length} votações relevantes.`;
          help.style.display = 'none'; err.style.display = 'none';
          listTbody.innerHTML = '';
          filtered.forEach(item => {
            const id = item.id || item?.idVotacao || '';
            const dataHora = item.dataHoraRegistro || item.dataHora || '';
            const descricao = item.descricao || item?.descrição || '';
            const resultado = item?.resultado || '';
            const votosCount = Number(item.votes_count || 0);
            const tr = document.createElement('tr');
            const baseGerencial = `${window.location.origin}/gerencial/`;
            const hrefFull = `${baseGerencial}?proposicao_id=${encodeURIComponent(propId)}&consulta_id=${encodeURIComponent(id)}`;
            tr.innerHTML = `<td style=\"padding:6px;\"><a href=\"${hrefFull}\" data-id=\"${id}\" class=\"vb-votacao-id\">${id}</a></td>`+
                           `<td style=\"padding:6px;\">${dataHora || ''}</td>`+
                           `<td style=\"padding:6px;\">${descricao || ''}</td>`+
                           `<td style=\"padding:6px;\">${resultado || ''}</td>`+
                           `<td style=\"padding:6px;\">${votosCount}</td>`;
            listTbody.appendChild(tr);
          });
          listTbody.querySelectorAll('a.vb-votacao-id').forEach(a => {
            a.addEventListener('click', (e) => {
              e.preventDefault();
              const idSel = a.getAttribute('data-id');
              if (votacaoInput) {
                votacaoInput.value = idSel || '';
                btnCarregarVotacao.style.display = (idSel ? 'inline-block' : 'none');
                btnCarregarVotacao.focus();
              }
            });
          });
        })
        .catch(err0 => {
          status.textContent = '';
          help.style.display = 'none'; err.style.display = 'block';
          listTbody.innerHTML = '';
          const safeUrl = url;
          err.innerHTML = `<div class="alert alert-danger" style="margin:0;">Ocorreu um erro ao consultar a API da Câmara. Verifique o ID e tente novamente. URL: <a href="${safeUrl}" target="api">${safeUrl}</a></div>`;
        });
    });

    // Botão para importar votos oficiais
    if (btnCarregarVotacao) {
      btnCarregarVotacao.addEventListener('click', function(ev){
        ev.preventDefault();
        const vRaw = (votacaoInput && votacaoInput.value ? votacaoInput.value.trim() : '');
        const pRaw = (propInput && propInput.value ? propInput.value.trim() : '');
        let propId = '';
        let sufixo = '';
        let composed = '';
        if (vRaw.includes('-')) {
          const parts = vRaw.split('-');
          propId = (parts[0]||'').trim();
          sufixo = (parts[1]||'').trim();
          composed = `${propId}-${sufixo}`;
        } else {
          propId = pRaw;
          sufixo = vRaw;
          composed = propId && sufixo ? `${propId}-${sufixo}` : '';
        }
        if (!propId || !sufixo) {
          status.textContent = 'Informe Proposição ID e o sufixo/ID da votação (ex: 2270800-160).';
          card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
          return;
        }
        const url = `${window.location.origin}/gerencial/ajax/import-congress-votes/?proposicao_id=${encodeURIComponent(propId)}&consulta_id=${encodeURIComponent(sufixo)}`;
        status.textContent = `Importando votos oficiais de ${composed}...`;
        card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
        if (hintLoading) hintLoading.style.display = 'inline';
        if (hintText) hintText.style.display = 'none';
        fetch(url, { headers: { 'Accept': 'application/json' } })
          .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
          .then(resp => {
            if (!resp.ok || !resp.body?.ok) {
              const apiUrl = resp.body?.api_url || '';
              status.textContent = '';
              err.style.display = 'block'; help.style.display = 'none';
              err.innerHTML = `<div class="alert alert-danger" style="margin:0;">Erro ao importar votos.${apiUrl ? ` URL: <a href="${apiUrl}" target="api">${apiUrl}</a>` : ''}</div>`;
              if (hintLoading) hintLoading.style.display = 'none';
              if (hintText) hintText.style.display = 'inline';
              return;
            }
            const json = resp.body;
            const created = Number(json.created||0);
            const updated = Number(json.updated||0);
            const skipped = Number(json.skipped||0);
            status.textContent = `Importação concluída. Criados: ${created}, Atualizados: ${updated}, Ignorados: ${skipped}.`;
            state.data = Array.isArray(json.votos) ? json.votos : [];
            applyFilters();
            if (hintLoading) hintLoading.style.display = 'none';
            if (hintText) hintText.style.display = 'inline';
          })
          .catch(e => {
            status.textContent = '';
            err.style.display = 'block'; help.style.display = 'none';
            err.innerHTML = `<div class="alert alert-danger" style="margin:0;">Falha de rede ao importar votos. Tente novamente.</div>`;
            if (hintLoading) hintLoading.style.display = 'none';
            if (hintText) hintText.style.display = 'inline';
          });
      });
    }
  })();


  // ---- Common filtering and rendering logic (shared behavior) ----
  function uniq(arr) { return Array.from(new Set(arr.filter(Boolean))).sort(); }
  function renderOptions(sel, values) {
    const el = document.getElementById(sel);
    const cur = el.value;
    const base = el.querySelector('option');
    el.innerHTML = '';
    if (base) el.appendChild(base);
    values.forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v; el.appendChild(o);
    });
    el.value = cur;
  }

  function computeStats(items, key) {
    const map = {};
    items.forEach(x => {
      const k = (x[key] || '').trim();
      if (!k) return;
      map[k] = map[k] || { 'Sim':0, 'Não':0, 'Abstenção':0, 'Não compareceu':0 };
      const v = x.voto || '';
      if (map[k][v] !== undefined) map[k][v]++;
    });
    return map;
  }

  function asArray(statsMap) {
    return Object.keys(statsMap).map(k => {
      const s = statsMap[k];
      const total = (s['Sim']||0) + (s['Não']||0) + (s['Abstenção']||0) + (s['Não compareceu']||0);
      const pct = {
        'Sim': total ? Math.round((s['Sim']||0) * 100 / total) : 0,
        'Não': total ? Math.round((s['Não']||0) * 100 / total) : 0,
        'Abstenção': total ? Math.round((s['Abstenção']||0) * 100 / total) : 0,
        'Não compareceu': total ? Math.round((s['Não compareceu']||0) * 100 / total) : 0,
      };
      return { key: k, counts: s, total, pct };
    });
  }

  function sortStats(arr, sort) {
    if (!sort || !sort.field) return arr.sort((a,b) => a.key.localeCompare(b.key));
    const asc = sort.dir === 'asc';
    return arr.sort((a,b) => {
      const ap = a.pct[sort.field] || 0;
      const bp = b.pct[sort.field] || 0;
      if (ap !== bp) return asc ? (ap - bp) : (bp - ap);
      return a.key.localeCompare(b.key);
    });
  }

  function renderStatsTable(tableId, statsMap, sort) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = '';
    const rows = sortStats(asArray(statsMap), sort);
    rows.forEach(r => {
      function fmt(count, pct) { return `${count} (${pct}%)`; }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style=\"padding:6px;\">${r.key}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Sim']||0, r.pct['Sim'])}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Não']||0, r.pct['Não'])}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Abstenção']||0, r.pct['Abstenção'])}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Não compareceu']||0, r.pct['Não compareceu'])}</td>`;
      tbody.appendChild(tr);
    });
    updateSortIcons(tableId, sort);
  }

  function updateSortIcons(tableId, sort) {
    document.querySelectorAll(`#${tableId} thead th[data-field]`).forEach(th => {
      const f = th.getAttribute('data-field');
      const icon = th.querySelector('i.sort-icon');
      const hint = th.querySelector('i.sort-hint');
      if (!icon || !hint) return;
      if (sort && sort.field === f) {
        icon.className = `sort-icon bi ${sort.dir === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill'}`;
        icon.style.display = 'inline-block';
        hint.style.display = 'none';
      } else {
        icon.style.display = 'none';
        hint.style.display = 'inline-block';
      }
    });
  }

  function applyFilters() {
    const nome = document.getElementById('f-nome').value.toLowerCase();
    const tokens = nome.split(/\s+/).filter(Boolean);
    const partido = document.getElementById('f-partido').value;
    const uf = document.getElementById('f-uf').value;
    const voto = document.getElementById('f-voto').value;
    state.filtered = state.data.filter(x => {
      const nomeLower = (x.nome||'').toLowerCase();
      const nomeMatch = tokens.length === 0 ? true : tokens.every(t => nomeLower.includes(t));
      return (nomeMatch) &&
             (!partido || x.partido === partido) &&
             (!uf || x.uf === uf) &&
             (!voto || x.voto === voto);
    });
    renderList();
    renderStats();
  }

  function renderList() {
    const tbody = document.querySelector('#table-list tbody');
    tbody.innerHTML = '';
    state.filtered.forEach(x => {
      const idc = x.id_cadastro ? String(x.id_cadastro) : '';
      const href = idc ? `https://www.camara.leg.br/deputados/${idc}` : '';
      const nameHtml = href ? `<a href="${href}" target="deputado">${x.nome||''}</a>` : (x.nome||'');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style=\"padding:6px;\">${nameHtml}</td>`+
        `<td style=\"padding:6px;\">${x.partido||''}</td>`+
        `<td style=\"padding:6px;\">${x.uf||''}</td>`+
        `<td style=\"padding:6px;\">${x.voto||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  function bindSorting() {
    document.querySelectorAll('#table-partido thead th[data-field]').forEach(th => {
      th.addEventListener('click', () => {
        const f = th.getAttribute('data-field');
        if (sortState.partido.field === f) {
          sortState.partido.dir = sortState.partido.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.partido.field = f; sortState.partido.dir = 'desc';
        }
        renderStats();
      });
    });
    document.querySelectorAll('#table-uf thead th[data-field]').forEach(th => {
      th.addEventListener('click', () => {
        const f = th.getAttribute('data-field');
        if (sortState.uf.field === f) {
          sortState.uf.dir = sortState.uf.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.uf.field = f; sortState.uf.dir = 'desc';
        }
        renderStats();
      });
    });
  }

  function renderStats() {
    const byPartido = computeStats(state.filtered, 'partido');
    const byUf = computeStats(state.filtered, 'uf');
    renderStatsTable('table-partido', byPartido, sortState.partido);
    renderStatsTable('table-uf', byUf, sortState.uf);
  }

  function init() {
    renderOptions('f-partido', uniq(state.data.map(x => x.partido)));
    renderOptions('f-uf', uniq(state.data.map(x => x.uf)));
    ['f-nome','f-partido','f-uf','f-voto'].forEach(id => {
      document.getElementById(id).addEventListener('input', applyFilters);
      document.getElementById(id).addEventListener('change', applyFilters);
    });
    bindSorting();
    applyFilters();
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</div>