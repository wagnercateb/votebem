<div class="vb-votos-oficiais">
<style>
  /* Scoped styles to ensure identical look across public/admin bases */
  .vb-votos-oficiais .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 12px; }
  .vb-votos-oficiais .card-header { background: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 10px 15px; }
  .vb-votos-oficiais .card-header .card-title { margin: 0; color: #495057; }
  .vb-votos-oficiais .card-body { padding: 15px; }
  .vb-votos-oficiais .table td, .vb-votos-oficiais .table th { padding: 8px 12px; vertical-align: middle; }
  .vb-votos-oficiais .table tbody tr:hover { background-color: #f1f3f5; }
  .vb-votos-oficiais th[data-field] { cursor: pointer; }
  .vb-votos-oficiais .sort-icon, .vb-votos-oficiais .sort-hint { margin-left: 6px; }
  .vb-votos-oficiais .spin { animation: spin 1s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    {# Title row: keep H2 and add link to original proposição on the same line #}
    <div class="d-flex align-items-center gap-2">
      <h2 class="card-title mb-0">Votação oficial - Obter votos dos congressistas</h2>
      {# Link para a ficha da proposição na Câmara, com fallback simples #}
      {% if prop_id_for_header %}
        <a href="https://www.camara.leg.br/proposicoesWeb/fichadetramitacao?idProposicao={{ prop_id_for_header }}"
           target="_blank" rel="noopener"
           class="btn btn-sm btn-outline-primary">
          Proposição original
        </a>
      {% elif prefill_proposicao_id %}
        <a href="https://www.camara.leg.br/proposicoesWeb/fichadetramitacao?idProposicao={{ prefill_proposicao_id }}"
           target="_blank" rel="noopener"
           class="btn btn-sm btn-outline-primary">
          Proposição original
        </a>
      {% endif %}
    </div>
    {% if votacao %}
      <!-- Atualiza rótulo para “Voltar para votação Votebem” no contexto admin -->
      <a href="{% url 'voting:votacao_detail' votacao.id %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar para votação Votebem
      </a>
    {% endif %}
  </div>
  <div class="card-body">
    {% if votacao %}
      {# Removido: linha informativa em texto-muted "Votação: ..." #}
    {% else %}
      <!-- Form de busca e carregamento (ADMIN)
           - Botão [Carregar]: busca votações via API por Proposição ID e lista resultados filtrados
           - Botão [Carregar votação]: submete "votacao_id" (comportamento original) -->
      <form id="vb-votos-form" method="get" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label for="proposicao_id">Proposição ID:</label>
        <input id="proposicao_id" name="proposicao_id" type="number" min="1" class="form-control" style="max-width:160px;" value="{{ prefill_proposicao_id }}">

        <button id="btn-carregar-proposicao" type="submit" class="btn btn-primary">Carregar</button>

        <label for="votacao_id" style="margin-left:12px;">Votação ID:</label>
        <input id="votacao_id" name="votacao_id" type="text" class="form-control" style="max-width:160px;" placeholder="ex: 2270800-160">
        <button id="btn-carregar-votacao" type="button" class="btn btn-success" style="display:none;">Carregar votação</button>
      </form>
      <div class="form-text" id="vb-votos-hint" aria-live="polite">
        <span id="vb-votos-hint-text">Dica: pesquise por proposição, selecione uma votação e carregue a votação oficial.</span>
        <span id="vb-votos-loading" style="display:none;">
          <i class="bi bi-arrow-repeat spin" aria-hidden="true"></i>
          Carregando votação oficial, aguarde...
        </span>
      </div>
    {% endif %}
  </div>
</div>

{% if not votacao %}
<div class="card" id="vb-votacoes-card" style="display:none;">
  <div class="card-header"><h4 class="card-title">Votações encontradas (turnos / emenda aglutinativa)</h4></div>
  <div class="card-body">
    <div id="vb-votacoes-status" class="text-muted" style="margin-bottom:8px;"></div>
    <div class="table-responsive">
      <table class="table table-sm table-hover" id="vb-votacoes-list" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="padding:6px;">ID</th>
            <th style="padding:6px;">Data/Hora</th>
            <th style="padding:6px;">Descrição</th>
            <!-- Renamed column to reflect VoteBem actions instead of textual result -->
            <th style="padding:6px;">Votebem</th>
            <th style="padding:6px;">Qtd. registros</th>
            <th style="padding:6px;">Referências</th>
            <th style="padding:6px;">Prioridade</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card-body" id="vb-votacoes-help" style="display:none;">
    <div class="alert alert-info" style="margin:0;">
      Nenhuma votação correspondente foi encontrada para a proposição informada. Tente outro ID de proposição.
    </div>
  </div>
  <div class="card-body" id="vb-votacoes-error" style="display:none;">
    <div class="alert alert-danger" style="margin:0;">
      Ocorreu um erro ao consultar a API da Câmara. Verifique o ID e tente novamente.
    </div>
  </div>
</div>
{% endif %}


<script>
  const raw = {{ votos_json|default:'[]'|safe }};
  const state = { data: raw, filtered: raw };
  const sortState = {
    partido: { field: null, dir: 'desc' },
    uf: { field: null, dir: 'desc' }
  };

  // --- Busca de votações por Proposição ID na página /gerencial/ (ADMIN) ---
  (function initProposicaoLookup(){
    const form = document.getElementById('vb-votos-form');
    const btnCarregarProposicao = document.getElementById('btn-carregar-proposicao');
    const votacaoInput = document.getElementById('votacao_id');
    const btnCarregarVotacao = document.getElementById('btn-carregar-votacao');
    const propInput = document.getElementById('proposicao_id');
    const card = document.getElementById('vb-votacoes-card');
    const status = document.getElementById('vb-votacoes-status');
    const listTbody = document.querySelector('#vb-votacoes-list tbody');
    const help = document.getElementById('vb-votacoes-help');
    const err = document.getElementById('vb-votacoes-error');
    const hintText = document.getElementById('vb-votos-hint-text');
    const hintLoading = document.getElementById('vb-votos-loading');

    // Delegated click handler for Referências buttons to ensure reliability
    // Works even if rows are re-rendered or appended later.
    if (listTbody) {
      listTbody.addEventListener('click', function(ev) {
        const refsBtn = ev.target.closest('.vb-pv-refs');
        if (!refsBtn) return;
        ev.preventDefault();
        const tr = refsBtn.closest('tr');
        const pvId = refsBtn.getAttribute('data-pv-id');
        if (!pvId || !tr) return;
        toggleRefsPanel(tr, pvId);
      });
    }

    if (!form || !btnCarregarProposicao) return;

    // Prefill votacao_id/consulta_id from URL if present (supports opening the link directly)
    try {
      const params = new URLSearchParams(window.location.search);
      const vParam = params.get('votacao_id') || params.get('consulta_id');
      const pParam = params.get('proposicao_id');
      if (vParam && votacaoInput) {
        votacaoInput.value = vParam;
        btnCarregarVotacao.style.display = 'inline-block';
      }
      if (pParam && propInput) {
        propInput.value = pParam;
        // Auto-load votações da base local quando já há proposicao_id na URL
        const propId = String(pParam).trim();
        if (propId) {
          const urlDbOnly = `${window.location.origin}/gerencial/ajax/proposicao-votacoes/?proposicao_id=${encodeURIComponent(propId)}&db_only=1`;
          status.textContent = 'Carregando votações do banco (sem consultar API)...';
          card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
          listTbody.innerHTML = '';
          fetch(urlDbOnly, { headers: { 'Accept': 'application/json' } })
            .then(r => {
              if (!r.ok) throw new Error('HTTP ' + r.status);
              return r.json();
            })
            .then(json => {
              const dados = Array.isArray(json?.dados) ? json.dados : [];
              // Em carregamento automático (somente banco), não filtrar por descrição
              const filtered = dados;
              if (filtered.length === 0) {
                status.textContent = `Nenhuma votação registrada no banco para a proposição ${propId}.`;
                help.style.display = 'block'; err.style.display = 'none';
                listTbody.innerHTML = '';
                return;
              }
              status.textContent = `Foram encontradas ${filtered.length} votações (base local).`;
              help.style.display = 'none'; err.style.display = 'none';
              listTbody.innerHTML = '';
              // Render each voting row; when a VoteBem ID exists, show edit button
              filtered.forEach(item => {
                const id = item.id || item?.idVotacao || '';
                const dataHora = item.dataHoraRegistro || item.dataHora || '';
                const descricao = item.descricao || item?.descrição || '';
                // resultado textual from Câmara (not shown anymore in this column)
                const resultado = item?.resultado || '';
                const votosCount = Number(item.votes_count || 0);
                const tr = document.createElement('tr');
                const baseGerencial = `/gerencial/`;
                const hrefFull = `${baseGerencial}?proposicao_id=${encodeURIComponent(propId)}&consulta_id=${encodeURIComponent(id)}`;
                const prioridadeVal = (item.prioridade === null || item.prioridade === undefined) ? '' : String(item.prioridade);
                const pvId = item.pv_id || '';
                const vbId = item.vb_id || '';
                const prioridadeCell = pvId ? `<input type=\"number\" class=\"form-control form-control-sm vb-pv-prioridade\" value=\"${prioridadeVal}\" data-pv-id=\"${pvId}\" placeholder=\"\" style=\"max-width:90px;\" />` : `<span class=\"text-muted\">—</span>`;
                // Link para página pública usando o ID de ProposicaoVotacao (pv_id) quando disponível; caso contrário, usa vb_id
                const votosCell = (votosCount > 0 && (pvId || vbId)) ? `<a href=\"/voting/votos/oficiais/?votacao_id=${pvId || vbId}\" target=\"votos\">${votosCount}</a>` : `${votosCount}`;
                // Votebem cell: when vbId exists, show edit button; else show em dash
              const pvAdminPart = pvId ? ` <a href=\"/admin/voting/proposicaovotacao/${pvId}/change/\" class=\"btn btn-sm btn-outline-secondary\" target=\"pv-admin\" title=\"Editar ProposicaoVotacao\"><i class=\"bi bi-gear\"></i> PV</a>` : '';
              const votebemCell = vbId
                ? `<a href=\"/gerencial/votacao/${vbId}/edit/\" class=\"btn btn-sm btn-outline-primary\" target=\"vb-edit\" title=\"Editar votação VoteBem #${vbId}\"><i class=\"bi bi-pencil-square\"></i> Editar</a>${pvAdminPart}`
                : `<span class=\"text-muted\">—</span>${pvAdminPart}`;
                const refsCell = pvId ? `<button type=\"button\" class=\"btn btn-sm btn-outline-secondary vb-pv-refs\" data-pv-id=\"${pvId}\">Referências</button>` : `<span class=\"text-muted\">—</span>`;
                tr.innerHTML = `<td style=\"padding:6px;\"><a href=\"${hrefFull}\" data-id=\"${id}\" class=\"vb-votacao-id\">${id}</a></td>`+
                               `<td style=\"padding:6px;\">${dataHora || ''}</td>`+
                               `<td style=\"padding:6px;\">${descricao || ''}</td>`+
                               `<td style=\"padding:6px;\">${votebemCell}</td>`+
                               `<td style=\"padding:6px;\">${votosCell}</td>`+
                               `<td style=\"padding:6px;\">${refsCell}</td>`+
                               `<td style=\"padding:6px;\">${prioridadeCell}</td>`;
                listTbody.appendChild(tr);
              });
              bindPrioridadeEditors();
              // Bind direct listeners (delegation above covers dynamic updates)
              bindReferenciasButtons();
              listTbody.querySelectorAll('a.vb-votacao-id').forEach(a => {
                a.addEventListener('click', (e) => {
                  e.preventDefault();
                  const idSel = a.getAttribute('data-id');
                  if (votacaoInput) {
                    votacaoInput.value = idSel || '';
                    btnCarregarVotacao.style.display = (idSel ? 'inline-block' : 'none');
                    btnCarregarVotacao.focus();
                  }
                });
              });
            })
            .catch(e => {
              status.textContent = 'Falha ao carregar do banco (somente cache).';
              help.style.display = 'none'; err.style.display = 'block';
              listTbody.innerHTML = '';
            });
      }
      }
    } catch (_) { /* ignore */ }

    // Buscar votações da proposição sem submeter o formulário
    form.addEventListener('submit', function(ev){
      ev.preventDefault();
      const propId = (propInput && propInput.value) ? propInput.value.trim() : '';
      if (!propId) {
        status.textContent = 'Informe o Proposição ID para buscar votações.';
        card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
        listTbody.innerHTML = '';
        return;
      }
      let url = `${window.location.origin}/gerencial/ajax/proposicao-votacoes/?proposicao_id=${encodeURIComponent(propId)}`;
      status.textContent = 'Consultando votações (cache), aguarde...';
      card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
      listTbody.innerHTML = '';

      fetch(url, { headers: { 'Accept': 'application/json' } })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(json => {
          const dados = Array.isArray(json?.dados) ? json.dados : [];
          const needles = [ 'em primeiro turno', 'em segundo turno', 'emenda aglutinativa' ];
          const filtered = dados.filter(item => {
            const d = (item?.descricao || item?.descrição || '').toLowerCase();
            return needles.some(n => d.includes(n));
          });

          if (filtered.length === 0) {
            status.textContent = `Nenhuma votação correspondente para a proposição ${propId}.`;
            help.style.display = 'block'; err.style.display = 'none';
            listTbody.innerHTML = '';
            return;
          }

          status.textContent = `Foram encontradas ${filtered.length} votações relevantes.`;
          help.style.display = 'none'; err.style.display = 'none';
          listTbody.innerHTML = '';
          // Render each voting row; when a VoteBem ID exists, show edit button
          filtered.forEach(item => {
            const id = item.id || item?.idVotacao || '';
            const dataHora = item.dataHoraRegistro || item.dataHora || '';
            const descricao = item.descricao || item?.descrição || '';
            // resultado textual from Câmara (not shown anymore in this column)
            const resultado = item?.resultado || '';
            const votosCount = Number(item.votes_count || 0);
            const tr = document.createElement('tr');
            const baseGerencial = `/gerencial/`;
            const hrefFull = `${baseGerencial}?proposicao_id=${encodeURIComponent(propId)}&consulta_id=${encodeURIComponent(id)}`;
            const prioridadeVal = (item.prioridade === null || item.prioridade === undefined) ? '' : String(item.prioridade);
            const pvId = item.pv_id || '';
            const vbId = item.vb_id || '';
            const prioridadeCell = pvId ? `<input type=\"number\" class=\"form-control form-control-sm vb-pv-prioridade\" value=\"${prioridadeVal}\" data-pv-id=\"${pvId}\" placeholder=\"\" style=\"max-width:90px;\" />` : `<span class=\"text-muted\">—</span>`;
            // Link para página pública usando o ID de ProposicaoVotacao (pv_id) quando disponível; caso contrário, usa vb_id
            const votosCell = (votosCount > 0 && (pvId || vbId)) ? `<a href=\"/voting/votos/oficiais/?votacao_id=${pvId || vbId}\" target=\"votos\">${votosCount}</a>` : `${votosCount}`;
            // Votebem cell: when vbId exists, show edit button; else show em dash
            const votebemCell = vbId
              ? `<a href=\"/gerencial/votacao/${vbId}/edit/\" class=\"btn btn-sm btn-outline-primary\" target=\"vb-edit\" title=\"Editar votação VoteBem #${vbId}\"><i class=\"bi bi-pencil-square\"></i> Editar</a>`
              : `<span class=\"text-muted\">—</span>`;
            const refsCell = pvId ? `<button type=\"button\" class=\"btn btn-sm btn-outline-secondary vb-pv-refs\" data-pv-id=\"${pvId}\"><i class=\"bi bi-link-45deg\"></i>Referências1</button>` : `<span class=\"text-muted\">—</span>`;
            tr.innerHTML = `<td style=\"padding:6px;\"><a href=\"${hrefFull}\" data-id=\"${id}\" class=\"vb-votacao-id\">${id}</a></td>`+
                           `<td style=\"padding:6px;\">${dataHora || ''}</td>`+
                           `<td style=\"padding:6px;\">${descricao || ''}</td>`+
                           `<td style=\"padding:6px;\">${votebemCell}</td>`+
                           `<td style=\"padding:6px;\">${votosCell}</td>`+
                           `<td style=\"padding:6px;\">${refsCell}</td>`+
                           `<td style=\"padding:6px;\">${prioridadeCell}</td>`;
            listTbody.appendChild(tr);
          });
          // Bind save handlers for prioridade inputs (if any)
          bindPrioridadeEditors();
          bindReferenciasButtons();
          // Bind references panel toggles
          bindReferenciasButtons();
          listTbody.querySelectorAll('a.vb-votacao-id').forEach(a => {
            a.addEventListener('click', (e) => {
              e.preventDefault();
              const idSel = a.getAttribute('data-id');
              if (votacaoInput) {
                votacaoInput.value = idSel || '';
                btnCarregarVotacao.style.display = (idSel ? 'inline-block' : 'none');
                btnCarregarVotacao.focus();
              }
            });
          });
        })
        .catch(err0 => {
          status.textContent = '';
          help.style.display = 'none'; err.style.display = 'block';
          listTbody.innerHTML = '';
          // Show correct Câmara API URL reference for troubleshooting (consulta por proposição)
          const camaraUrl = `https://dadosabertos.camara.leg.br/api/v2/votacoes?idProposicao=${encodeURIComponent(propId)}&idOrgao=180`;
          err.innerHTML = `<div class="alert alert-danger" style="margin:0;">Ocorreu um erro ao consultar a API da Câmara. Verifique o ID e tente novamente. API (consulta por proposição): <a href="${camaraUrl}" target="api">${camaraUrl}</a></div>`;
        });
    });

    // Botão para importar votos oficiais
    if (btnCarregarVotacao) {
      btnCarregarVotacao.addEventListener('click', function(ev){
        ev.preventDefault();
        const vRaw = (votacaoInput && votacaoInput.value ? votacaoInput.value.trim() : '');
        const pRaw = (propInput && propInput.value ? propInput.value.trim() : '');
        let propId = '';
        let sufixo = '';
        let composed = '';
        if (vRaw.includes('-')) {
          const parts = vRaw.split('-');
          propId = (parts[0]||'').trim();
          sufixo = (parts[1]||'').trim();
          composed = `${propId}-${sufixo}`;
        } else {
          propId = pRaw;
          sufixo = vRaw;
          composed = propId && sufixo ? `${propId}-${sufixo}` : '';
        }
        if (!propId || !sufixo) {
          status.textContent = 'Informe Proposição ID e o sufixo/ID da votação (ex: 2270800-160).';
          card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
          return;
        }
        const url = `${window.location.origin}/gerencial/ajax/import-congress-votes/?proposicao_id=${encodeURIComponent(propId)}&consulta_id=${encodeURIComponent(sufixo)}`;
        status.textContent = `Importando votos oficiais de ${composed}...`;
        card.style.display = 'block'; help.style.display = 'none'; err.style.display = 'none';
        if (hintLoading) hintLoading.style.display = 'inline';
        if (hintText) hintText.style.display = 'none';
        fetch(url, { headers: { 'Accept': 'application/json' } })
          .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
          .then(resp => {
            if (!resp.ok || !resp.body?.ok) {
              const apiUrl = resp.body?.api_url || '';
              status.textContent = '';
              err.style.display = 'block'; help.style.display = 'none';
              err.innerHTML = `<div class="alert alert-danger" style="margin:0;">Erro ao importar votos.${apiUrl ? ` URL: <a href="${apiUrl}" target="api">${apiUrl}</a>` : ''}</div>`;
              if (hintLoading) hintLoading.style.display = 'none';
              if (hintText) hintText.style.display = 'inline';
              return;
            }
            const json = resp.body;
            const created = Number(json.created||0);
            const updated = Number(json.updated||0);
            const skipped = Number(json.skipped||0);
            status.textContent = `Importação concluída. Criados: ${created}, Atualizados: ${updated}, Ignorados: ${skipped}.`;
            state.data = Array.isArray(json.votos) ? json.votos : [];
            applyFilters();
            if (hintLoading) hintLoading.style.display = 'none';
            if (hintText) hintText.style.display = 'inline';
            // Após finalizar a importação, atualiza a página para refletir todos os dados
            window.location.reload();
          })
          .catch(e => {
            status.textContent = '';
            err.style.display = 'block'; help.style.display = 'none';
            err.innerHTML = `<div class="alert alert-danger" style="margin:0;">Falha de rede ao importar votos. Tente novamente.</div>`;
            if (hintLoading) hintLoading.style.display = 'none';
            if (hintText) hintText.style.display = 'inline';
          });
      });
    }
  })();

  // --- Helper: CSRF token from cookie
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // --- Bind editors for prioridade cells
  function bindPrioridadeEditors() {
    const inputs = document.querySelectorAll('#vb-votacoes-list .vb-pv-prioridade');
    inputs.forEach(inp => {
      const handler = () => {
        const pvId = inp.getAttribute('data-pv-id');
        const val = inp.value;
        if (!pvId) return;
        const formData = new URLSearchParams();
        formData.append('pv_id', pvId);
        formData.append('prioridade', val);
        fetch(`${window.location.origin}/gerencial/ajax/proposicao-votacao/update-prioridade/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
          },
          body: formData.toString(),
          credentials: 'same-origin'
        }).then(async r => {
          const ct = r.headers.get('Content-Type') || '';
          if (!r.ok) {
            // Read text to avoid JSON parse errors when server returns HTML (e.g., login redirect)
            const text = await r.text();
            throw new Error(`HTTP ${r.status} (${ct}); ${text.slice(0, 120)}`);
          }
          return r.json();
        }).then(json => {
          if (!json?.ok) {
            console.error('Erro ao atualizar prioridade:', json?.error);
            inp.classList.add('is-invalid');
          } else {
            inp.classList.remove('is-invalid');
            inp.classList.add('is-valid');
            setTimeout(() => inp.classList.remove('is-valid'), 1200);
          }
        }).catch(e => {
          console.error('Falha de rede ao atualizar prioridade:', e);
          // Hint for common auth issue: staff session required
          const hint = document.getElementById('vb-votacoes-error');
          if (hint) {
            hint.style.display = 'block';
            hint.textContent = 'Falha ao salvar prioridade. Verifique se você está logado como staff e se o CSRF está válido.';
          }
          inp.classList.add('is-invalid');
        });
      };
      inp.addEventListener('change', handler);
      inp.addEventListener('blur', handler);
      inp.addEventListener('keyup', (ev) => { if (ev.key === 'Enter') handler(); });
    });
  }

  // --- Referências (CRUD) subform per row ---
  function bindReferenciasButtons() {
    // Direct bindings disabled in favor of event delegation on tbody.
    // This prevents duplicate handlers causing immediate toggle to hidden.
    return;
  }

  function toggleRefsPanel(tr, pvId) {
    // If panel exists next row, toggle; else create and load
    const next = tr.nextElementSibling;
    if (next && next.classList.contains('vb-refs-row')) {
      const body = next.querySelector('.vb-refs-body');
      if (body) body.style.display = body.style.display === 'none' ? 'block' : 'none';
      return;
    }
    const panel = document.createElement('tr');
    panel.className = 'vb-refs-row';
    const colspan = tr.children.length; // span across all columns
    // Ensure initial visibility: set vb-refs-body to display:block
    panel.innerHTML = `<td colspan="${colspan}" style="padding:8px 12px; background:#f9fafb;">
        <div class="vb-refs-body" style="display:block;">
          <div class="d-flex justify-content-between align-items-center" style="margin-bottom:6px;">
            <strong>Referências vinculadas</strong>
            <small class="text-muted">PV #${pvId}</small>
          </div>
          <div class="row g-2" style="margin-bottom:8px;">
            <div class="col-md-6">
              <input type="url" class="form-control form-control-sm vb-ref-url" placeholder="https://...">
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm vb-ref-kind">
                <option value="web_page">Página Web</option>
                <option value="sound">Áudio</option>
                <option value="social_media">Rede Social</option>
              </select>
            </div>
            <div class="col-md-3 text-end">
              <button type="button" class="btn btn-sm btn-primary vb-ref-add">Adicionar</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover vb-refs-table">
              <thead>
                <tr>
                  <th style="padding:6px;">URL</th>
                  <th style="padding:6px;">Tipo</th>
                  <th style="padding:6px;">Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="vb-refs-status text-muted" style="font-size:0.9em;"></div>
        </div>
      </td>`;
    tr.parentNode.insertBefore(panel, tr.nextSibling);
    const body = panel.querySelector('.vb-refs-body');
    const addBtn = panel.querySelector('.vb-ref-add');
    const urlInp = panel.querySelector('.vb-ref-url');
    const kindSel = panel.querySelector('.vb-ref-kind');
    const tableBody = panel.querySelector('.vb-refs-table tbody');
    const statusEl = panel.querySelector('.vb-refs-status');

    // Ensure panel is shown and visible immediately, and focus URL input
    if (body) body.style.display = 'block';
    try { panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) {}
    if (urlInp) urlInp.focus();

    addBtn.addEventListener('click', () => {
      const url = (urlInp.value || '').trim();
      const kind = kindSel.value || 'web_page';
      if (!url) { statusEl.textContent = 'Informe uma URL válida.'; return; }
      const formData = new URLSearchParams();
      formData.append('pv_id', pvId);
      formData.append('url', url);
      formData.append('kind', kind);
      fetch(`${window.location.origin}/gerencial/ajax/referencias/create/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: formData.toString(),
        credentials: 'same-origin'
      }).then(r => r.json()).then(json => {
        if (!json?.ok) { statusEl.textContent = json?.error || 'Falha ao criar referência.'; return; }
        urlInp.value = '';
        kindSel.value = 'web_page';
        statusEl.textContent = 'Referência adicionada.';
        renderRefsRows(tableBody, [json.ref], pvId);
      }).catch(e => { statusEl.textContent = 'Erro de rede ao criar referência.'; });
    });

    // Inicial load
    statusEl.textContent = 'Carregando referências...';
    fetch(`${window.location.origin}/gerencial/ajax/referencias/list/?pv_id=${encodeURIComponent(pvId)}`, { headers: { 'Accept': 'application/json' } })
      .then(r => r.json())
      .then(json => {
        if (!json?.ok) { statusEl.textContent = json?.error || 'Falha ao carregar.'; return; }
        statusEl.textContent = `${(json.dados||[]).length} referência(s).`;
        renderRefsRows(tableBody, json.dados || [], pvId);
      })
      .catch(e => { statusEl.textContent = 'Erro de rede ao carregar referências.'; });
  }

  function renderRefsRows(tbody, refs, pvId) {
    refs.forEach(r => {
      const tr = document.createElement('tr');
      const esc = (s) => String(s||'');
      tr.innerHTML = `<td style="padding:6px;">
                        <input type="url" class="form-control form-control-sm vb-ref-url-edit" value="${esc(r.url)}" data-ref-id="${r.id}">
                      </td>
                      <td style="padding:6px;">
                        <select class="form-select form-select-sm vb-ref-kind-edit" data-ref-id="${r.id}">
                          <option value="web_page" ${r.kind==='web_page'?'selected':''}>Página Web</option>
                          <option value="sound" ${r.kind==='sound'?'selected':''}>Áudio</option>
                          <option value="social_media" ${r.kind==='social_media'?'selected':''}>Rede Social</option>
                        </select>
                      </td>
                      <td style="padding:6px;">
                        <button type="button" class="btn btn-sm btn-success vb-ref-save" data-ref-id="${r.id}"><i class="bi bi-check"></i> Salvar</button>
                        <button type="button" class="btn btn-sm btn-outline-danger vb-ref-del" data-ref-id="${r.id}"><i class="bi bi-trash"></i> Excluir</button>
                      </td>`;
      tbody.appendChild(tr);
    });
    bindRefsRowActions(tbody);
  }

  function bindRefsRowActions(tbody) {
    const saveBtns = tbody.querySelectorAll('.vb-ref-save');
    const delBtns = tbody.querySelectorAll('.vb-ref-del');
    saveBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const refId = btn.getAttribute('data-ref-id');
        const row = btn.closest('tr');
        const urlInp = row.querySelector('.vb-ref-url-edit');
        const kindSel = row.querySelector('.vb-ref-kind-edit');
        const formData = new URLSearchParams();
        formData.append('ref_id', refId);
        formData.append('url', (urlInp.value||'').trim());
        formData.append('kind', kindSel.value||'web_page');
        fetch(`${window.location.origin}/gerencial/ajax/referencias/update/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCookie('csrftoken') || '' },
          body: formData.toString(),
          credentials: 'same-origin'
        }).then(r => r.json()).then(json => {
          if (!json?.ok) { alert(json?.error || 'Falha ao salvar.'); return; }
          btn.classList.add('btn-success');
          setTimeout(() => btn.classList.remove('btn-success'), 800);
        }).catch(e => { alert('Erro de rede ao salvar.'); });
      });
    });
    delBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const refId = btn.getAttribute('data-ref-id');
        if (!confirm('Excluir esta referência?')) return;
        const formData = new URLSearchParams();
        formData.append('ref_id', refId);
        fetch(`${window.location.origin}/gerencial/ajax/referencias/delete/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCookie('csrftoken') || '' },
          body: formData.toString(),
          credentials: 'same-origin'
        }).then(r => r.json()).then(json => {
          if (!json?.ok) { alert(json?.error || 'Falha ao excluir.'); return; }
          const row = btn.closest('tr');
          if (row) row.remove();
        }).catch(e => { alert('Erro de rede ao excluir.'); });
      });
    });
  }


  // ---- Common filtering and rendering logic (shared behavior) ----
  function uniq(arr) { return Array.from(new Set(arr.filter(Boolean))).sort(); }
  function renderOptions(sel, values) {
    const el = document.getElementById(sel);
    if (!el) return; // Safeguard when element is not present on the page
    const cur = el.value;
    const base = el.querySelector('option');
    el.innerHTML = '';
    if (base) el.appendChild(base);
    values.forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v; el.appendChild(o);
    });
    el.value = cur;
  }

  function computeStats(items, key) {
    const map = {};
    items.forEach(x => {
      const k = (x[key] || '').trim();
      if (!k) return;
      map[k] = map[k] || { 'Sim':0, 'Não':0, 'Abstenção':0, 'Não compareceu':0 };
      const v = x.voto || '';
      if (map[k][v] !== undefined) map[k][v]++;
    });
    return map;
  }

  function asArray(statsMap) {
    return Object.keys(statsMap).map(k => {
      const s = statsMap[k];
      const total = (s['Sim']||0) + (s['Não']||0) + (s['Abstenção']||0) + (s['Não compareceu']||0);
      const pct = {
        'Sim': total ? Math.round((s['Sim']||0) * 100 / total) : 0,
        'Não': total ? Math.round((s['Não']||0) * 100 / total) : 0,
        'Abstenção': total ? Math.round((s['Abstenção']||0) * 100 / total) : 0,
        'Não compareceu': total ? Math.round((s['Não compareceu']||0) * 100 / total) : 0,
      };
      return { key: k, counts: s, total, pct };
    });
  }

  function sortStats(arr, sort) {
    if (!sort || !sort.field) return arr.sort((a,b) => a.key.localeCompare(b.key));
    const asc = sort.dir === 'asc';
    return arr.sort((a,b) => {
      const ap = a.pct[sort.field] || 0;
      const bp = b.pct[sort.field] || 0;
      if (ap !== bp) return asc ? (ap - bp) : (bp - ap);
      return a.key.localeCompare(b.key);
    });
  }

  function renderStatsTable(tableId, statsMap, sort) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    if (!tbody) return; // Guard when stats tables are not present
    tbody.innerHTML = '';
    const rows = sortStats(asArray(statsMap), sort);
    rows.forEach(r => {
      function fmt(count, pct) { return `${count} (${pct}%)`; }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style=\"padding:6px;\">${r.key}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Sim']||0, r.pct['Sim'])}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Não']||0, r.pct['Não'])}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Abstenção']||0, r.pct['Abstenção'])}</td>`+
        `<td style=\"padding:6px;\">${fmt(r.counts['Não compareceu']||0, r.pct['Não compareceu'])}</td>`;
      tbody.appendChild(tr);
    });
    updateSortIcons(tableId, sort);
  }

  function updateSortIcons(tableId, sort) {
    document.querySelectorAll(`#${tableId} thead th[data-field]`).forEach(th => {
      const f = th.getAttribute('data-field');
      const icon = th.querySelector('i.sort-icon');
      const hint = th.querySelector('i.sort-hint');
      if (!icon || !hint) return;
      if (sort && sort.field === f) {
        icon.className = `sort-icon bi ${sort.dir === 'asc' ? 'bi-caret-up-fill' : 'bi-caret-down-fill'}`;
        icon.style.display = 'inline-block';
        hint.style.display = 'none';
      } else {
        icon.style.display = 'none';
        hint.style.display = 'inline-block';
      }
    });
  }

  function applyFilters() {
    const nomeEl = document.getElementById('f-nome');
    const partidoEl = document.getElementById('f-partido');
    const ufEl = document.getElementById('f-uf');
    const votoEl = document.getElementById('f-voto');
    const nome = ((nomeEl && nomeEl.value) ? nomeEl.value : '').toLowerCase();
    const tokens = nome.split(/\s+/).filter(Boolean);
    const partido = (partidoEl ? partidoEl.value : '');
    const uf = (ufEl ? ufEl.value : '');
    const voto = (votoEl ? votoEl.value : '');
    state.filtered = state.data.filter(x => {
      const nomeLower = (x.nome||'').toLowerCase();
      const nomeMatch = tokens.length === 0 ? true : tokens.every(t => nomeLower.includes(t));
      return (nomeMatch) &&
             (!partido || x.partido === partido) &&
             (!uf || x.uf === uf) &&
             (!voto || x.voto === voto);
    });
    renderList();
    renderStats();
  }

  function renderList() {
    const tbody = document.querySelector('#table-list tbody');
    if (!tbody) return; // Guard when list table is not present
    tbody.innerHTML = '';
    state.filtered.forEach(x => {
      const idc = x.id_cadastro ? String(x.id_cadastro) : '';
      const href = idc ? `https://www.camara.leg.br/deputados/${idc}` : '';
      const nameHtml = href ? `<a href="${href}" target="deputado">${x.nome||''}</a>` : (x.nome||'');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style=\"padding:6px;\">${nameHtml}</td>`+
        `<td style=\"padding:6px;\">${x.partido||''}</td>`+
        `<td style=\"padding:6px;\">${x.uf||''}</td>`+
        `<td style=\"padding:6px;\">${x.voto||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  function bindSorting() {
    document.querySelectorAll('#table-partido thead th[data-field]').forEach(th => {
      th.addEventListener('click', () => {
        const f = th.getAttribute('data-field');
        if (sortState.partido.field === f) {
          sortState.partido.dir = sortState.partido.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.partido.field = f; sortState.partido.dir = 'desc';
        }
        renderStats();
      });
    });
    document.querySelectorAll('#table-uf thead th[data-field]').forEach(th => {
      th.addEventListener('click', () => {
        const f = th.getAttribute('data-field');
        if (sortState.uf.field === f) {
          sortState.uf.dir = sortState.uf.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.uf.field = f; sortState.uf.dir = 'desc';
        }
        renderStats();
      });
    });
  }

  function renderStats() {
    const byPartido = computeStats(state.filtered, 'partido');
    const byUf = computeStats(state.filtered, 'uf');
    renderStatsTable('table-partido', byPartido, sortState.partido);
    renderStatsTable('table-uf', byUf, sortState.uf);
  }

  function init() {
    renderOptions('f-partido', uniq(state.data.map(x => x.partido)));
    renderOptions('f-uf', uniq(state.data.map(x => x.uf)));
    ['f-nome','f-partido','f-uf','f-voto'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return; // Guard when filter controls are not present
      el.addEventListener('input', applyFilters);
      el.addEventListener('change', applyFilters);
    });
    bindSorting();
    applyFilters();
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</div>