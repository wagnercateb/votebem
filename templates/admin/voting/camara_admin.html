{% extends "admin/voting/base_administrativo.html" %}

{% block title %}Administra√ß√£o C√¢mara - VoteBem{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">C√¢mara Admin</li>
{% endblock %}

{% block extra_css %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
    }
    
    .admin-header p {
        margin: 10px 0 0 0;
        font-size: 1.1em;
        opacity: 0.9;
    }
    
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }
    
    .action-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-top: 4px solid #28a745;
        transition: transform 0.3s ease;
    }
    
    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .action-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.3em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .btn-action {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #1e7e34;
        color: white;
        text-decoration: none;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-warning:hover {
        background: #e0a800;
        color: #212529;
        text-decoration: none;
    }
    
    .btn-info {
        background: #17a2b8;
        color: white;
    }
    
    .btn-info:hover {
        background: #138496;
        color: white;
        text-decoration: none;
    }
    
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }
    
    .form-section h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.3em;
        font-weight: 600;
        border-bottom: 2px solid #28a745;
        padding-bottom: 10px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9em;
    }
    
    .form-control:focus {
        border-color: #28a745;
        outline: none;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
    }
    
    .results-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 25px;
    }
    
    .results-section h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.3em;
        font-weight: 600;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table th {
        background: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
        padding: 12px;
    }
    
    .table td {
        padding: 12px;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .icon {
        font-size: 1.2em;
    }
    
    .text-muted {
        color: #6c757d !important;
    }
    
    .mb-0 {
        margin-bottom: 0 !important;
    }
    
    .form-section {
        margin-bottom: 30px;
    }
    
    .card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .card-header h4 {
        margin: 0;
        font-size: 1.2em;
        font-weight: 600;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }
    
    .form-control {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .alert {
        padding: 12px 15px;
        border-radius: 4px;
        border: 1px solid transparent;
    }
    
    .alert-info {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }
</style>

<script>

        // Toggle helper for showing/hiding sections by element id
        function toggleSection(sectionId) {
            const el = document.getElementById(sectionId);
            if (!el) return;
            const isHidden = el.style.display === 'none' || el.style.display === '';
            el.style.display = isHidden ? 'block' : 'none';
            if (!isHidden) return;
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Date initialization is now handled directly in HTML template with Django context variables
        

    </script>
{% endblock %}

{% block content %}
<h2>Proposi√ß√µes > adicionar em lote, por per√≠odo</h2>

S√≥ atualiza as proposi√ß√µes, n√£o busca seus temas ou vota√ß√µes

<!-- Datas agora usam inputs nativos type="date"; convers√µes cliente n√£o s√£o necess√°rias. -->

<!-- Bot√µes para exibir se√ß√µes ocultas -->
<div class="action-buttons mb-3">
    <!-- Bot√£o: listar proposi√ß√µes j√° votadas (refatorado para enviar POST diretamente) -->
    <form method="post" style="display: inline;">
        {% csrf_token %}
        <input type="hidden" name="action" value="listarProposicoesVotadas">
        <button type="submit" class="btn-action btn-success" title="Lista proposi√ß√µes cujas vota√ß√µes oficiais j√° foram carregadas" data-bs-toggle="tooltip" data-bs-placement="top">
            <span class="icon">‚úÖ</span> Proposi√ß√µes com vota√ß√µes oficiais
        </button>
    </form>
    <!-- Bot√£o: atualizar proposi√ß√µes dos √∫ltimos 30 dias (form submit) -->
    <form method="post" style="display: inline; margin-left: 8px;">
        {% csrf_token %}
        <input type="hidden" name="action" value="atualizarNProposicoes">
    </form>

    <!-- Bot√£o: configurar atualiza√ß√£o (mostrar/ocultar formul√°rio de par√¢metros) -->
    <!-- <button type="button" class="btn-action btn-success" onclick="toggleSection('atualizarNSection')" title="Atualizar N proposi√ß√µes, a partir da proposi√ß√£o X, com timeout bem definido" data-bs-toggle="tooltip" data-bs-placement="top">
        <span class="icon">‚öôÔ∏è</span> Atualizar N proposi√ß√µes
    </button> -->

    <!-- Bot√£o: mostrar/ocultar Sincroniza√ß√£o (3 meses) -->
    <button type="button" class="btn-action btn-info" onclick="toggleSection('sync3mesesSection')" title="(demorado) Atualizar lista de proposi√ß√µes apresentadas ou com mudan√ßa de situa√ß√£o entre dataInicio e dataFim" data-bs-toggle="tooltip" data-bs-placement="top">
        <span class="icon">üóìÔ∏è</span>Atualizar proposi√ß√µes por per√≠odo
    </button>

    <!-- Bot√£o: mostrar/ocultar Listagem por Per√≠odo -->
    <button type="button" class="btn-action btn-primary" onclick="toggleSection('listarPeriodoSection')" title="Exibe/oculta a se√ß√£o de listagem por per√≠odo" data-bs-toggle="tooltip" data-bs-placement="top">
        <span class="icon">üìÖ</span> Listar Proposi√ß√µes Apresentadas num Per√≠odo
    </button>

    
</div>

<!-- Painel removido: Proposi√ß√µes Votadas (agora acionado diretamente pelo bot√£o acima) -->

<!-- Formul√°rio configur√°vel: Atualizar N Proposi√ß√µes (√∫ltimos 30 dias) -->
<div id="atualizarNSection" class="form-section" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h4><span class="icon">‚öôÔ∏è</span> Atualizar N Proposi√ß√µes</h4>
        </div>
        <div class="card-body">
            <form method="post" id="atualizarNForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="atualizarNProposicoes">

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="nProximasProposicoes">Quantidade de proposi√ß√µes a processar</label>
                            <input type="number" class="form-control" id="nProximasProposicoes" name="nProximasProposicoes" min="1" value="10" title="N√∫mero de proposi√ß√µes recentes a processar" data-bs-toggle="tooltip" data-bs-placement="top">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="aPartirDaProposicao">A partir da proposi√ß√£o (opcional)</label>
                            <input type="text" class="form-control" id="aPartirDaProposicao" name="aPartirDaProposicao" placeholder="ID da proposi√ß√£o ou vazio" title="Opcional: informe um ID para come√ßar a partir dele" data-bs-toggle="tooltip" data-bs-placement="top">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="tempoMaximoProcess">Tempo m√°ximo de processamento (segundos)</label>
                            <input type="number" class="form-control" id="tempoMaximoProcess" name="tempoMaximoProcess" min="10" value="150" title="Limite de tempo para a opera√ß√£o" data-bs-toggle="tooltip" data-bs-placement="top">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn-action btn-success" title="Executa a atualiza√ß√£o com os par√¢metros informados" data-bs-toggle="tooltip" data-bs-placement="top">
                            <span class="icon">üîÑ</span> Atualizar Agora
                        </button>
                        <button type="button" class="btn-action btn-secondary" onclick="toggleSection('atualizarNSection')" title="Fechar este formul√°rio" data-bs-toggle="tooltip" data-bs-placement="top">
                            <span class="icon">‚ùå</span> Cancelar
                        </button>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <strong>Dica:</strong> Deixe "A partir da proposi√ß√£o" vazio para processar as mais recentes. Ajuste a quantidade e o tempo conforme necess√°rio.
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sync by Date Range Form -->
<!-- Inicialmente oculto; exibido ao clicar no bot√£o correspondente -->
<div id="sync3mesesSection" class="form-section" style="display: none;">
    <h3>üóìÔ∏è Atualizar proposi√ß√µes (buscar online) (por data de apresenta√ß√£o???)</h3>
    <form method="post" id="syncDateRangeForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="atualizarProposicoesVotadasPlenario">
        
        {% if sync_error %}
        <div class="alert alert-danger">
            <strong>Erro:</strong> {{ sync_error }}
        </div>
        {% endif %}
        
        {% if error %}
        <div class="alert alert-danger">
            <strong>Erro:</strong> {{ error }}
        </div>
        {% endif %}
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="dataInicial">Data Inicial:</label>
                    <input type="date" id="dataInicial" name="dataInicial" class="form-control" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="dataFinal">Data Final:</label>
                    <!-- Made editable: removed readonly to allow manual date selection -->
                    <input type="date" id="dataFinal" name="dataFinal" class="form-control" required>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <strong>Nota:</strong> A data final ser√° automaticamente definida como 3 meses ap√≥s a data inicial. 
            O per√≠odo m√°ximo permitido √© de 3 meses para evitar sobrecarga do sistema.
        </div>
        
        <!-- Tooltip: sync propositions by date range -->
        <button type="submit" class="btn-action btn-primary" title="Sincroniza proposi√ß√µes votadas no plen√°rio no per√≠odo (m√°x. 3 meses)" data-bs-toggle="tooltip" data-bs-placement="top">
            <span class="icon">üîÑ</span> Atualizar Proposi√ß√µes do Per√≠odo
        </button>
    </form>
</div>

<!-- Date Range Form -->
<!-- Inicialmente oculto; exibido ao clicar no bot√£o correspondente -->
<div id="listarPeriodoSection" class="form-section" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">üìÖ Proposi√ß√µes Movimentadas por Per√≠odo (busca online)</h3>
        <!-- Removed: link to 'Listar proposi√ß√µes carregadas' as requested -->
    </div>
    
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="listarProposicoesTramitacao">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="dataInicio">Data In√≠cio:</label>
                    <input type="date" id="dataInicio" name="dataInicio" class="form-control" value="{{ default_data_inicio }}">
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="dataFim">Data Fim:</label>
                    <input type="date" id="dataFim" name="dataFim" class="form-control" value="{{ default_data_fim }}">
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="tipoApi">Tipo API:</label>
                    <select id="tipoApi" name="tipoApi" class="form-control">
                        <option value="proposicoes">Proposi√ß√µes</option>
                        <option value="votacoes">Vota√ß√µes</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- Tooltip: list propositions by period online -->
        <button type="submit" class="btn-action btn-primary" title="Lista proposi√ß√µes por per√≠odo (consulta online)" data-bs-toggle="tooltip" data-bs-placement="top">
            <span class="icon">üîç</span> Listar Proposi√ß√µes
        </button>
    </form>
</div>

<!-- Results Sections -->

{% if action_result == 'api_test' %}
<div class="results-section">
    <h3>üåê Teste de Conex√£o com API da C√¢mara</h3>
    <div class="alert alert-info">
        <p><strong>Resultado:</strong> {{ api_test_result }}</p>
        {% if api_test_data %}
        <h4>Dados de Teste:</h4>
        <ul>
            <li><strong>ID:</strong> {{ api_test_data.id }}</li>
            <li><strong>Tipo:</strong> {{ api_test_data.siglaTipo }}</li>
            <li><strong>N√∫mero:</strong> {{ api_test_data.numero }}</li>
            <li><strong>Ano:</strong> {{ api_test_data.ano }}</li>
            <li><strong>Ementa:</strong> {{ api_test_data.ementa|truncatechars:200 }}</li>
        </ul>
        {% endif %}
    </div>
</div>
{% endif %}

{% if proposicoes_votadas %}
<div class="results-section">
    <h3>‚úÖ Proposi√ß√µes Votadas</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>N√∫mero</th>
                    <th>Ano</th>
                    <th>Ementa</th>
                    <th>Vota√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for proposicao in proposicoes_votadas %}
                <tr>
                    <!-- Make ID clickable to internal gerencial route (relative path avoids port issues) -->
                    <td><a href="/gerencial/?proposicao_id={{ proposicao.pk }}">{{ proposicao.pk }}</a></td>
                    <td>{{ proposicao.tipo }}</td>
                    <td>{{ proposicao.numero }}</td>
                    <td>{{ proposicao.ano }}</td>
                    <td>{{ proposicao.ementa|truncatechars:80 }}</td>
                    <td>{{ proposicao.total_votacoes }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if votacoes_disponiveis %}
<div class="results-section">
    <h3>üó≥Ô∏è Vota√ß√µes Dispon√≠veis</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Proposi√ß√£o</th>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Resultado</th>
                </tr>
            </thead>
            <tbody>
                {% for votacao in votacoes_disponiveis %}
                <tr>
                    <td>{{ votacao.id }}</td>
<td>{{ votacao.proposicao_votacao.proposicao_id }}</td>
                    <td>{{ votacao.data_hora_votacao|date:"d/m/Y H:i" }}</td>
                    <td>{{ votacao.descricao|truncatechars:80 }}</td>
                    <td>{{ votacao.aprovacao }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if tramitacao_result %}
<div class="results-section">
    <h3>üìã Proposi√ß√µes com alguma movimenta√ß√£o no per√≠odo selecionado</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>N√∫mero</th>
                    <th>Ano</th>
                    <th>Ementa</th>
                    <th>Status Atual</th>
                </tr>
            </thead>
            <tbody>
                {% for proposicao in tramitacao_result.proposicoes %}
                <tr>
                    <!-- Use relative link to work across environments/ports -->
                    <td><a href="/gerencial/?proposicao_id={{ proposicao.id }}">{{ proposicao.id }}</a></td>
                    <td>{{ proposicao.siglaTipo }}</td>
                    <td>{{ proposicao.numero }}</td>
                    <td>{{ proposicao.ano }}</td>
                    <td>{{ proposicao.ementa }}</td>
                    <td>{{ proposicao.statusProposicao.descricaoSituacao }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Date range calculation for sync form
    const dataInicialInput = document.getElementById('dataInicial');
    const dataFinalInput = document.getElementById('dataFinal');
    
    if (dataInicialInput && dataFinalInput) {
        dataInicialInput.addEventListener('change', function() {
            const dataInicial = new Date(this.value);
            if (dataInicial) {
                // Add 3 months to the initial date
                const dataFinal = new Date(dataInicial);
                dataFinal.setMonth(dataFinal.getMonth() + 3);
                
                // Format the date as YYYY-MM-DD for the input
                const year = dataFinal.getFullYear();
                const month = String(dataFinal.getMonth() + 1).padStart(2, '0');
                const day = String(dataFinal.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;
                
                dataFinalInput.value = formattedDate;
                
                console.log('Data inicial:', this.value, 'Data final calculada:', formattedDate);
            }
        });
        
        // Set default dates (current date and +3 months)
        const today = new Date();
        const todayFormatted = today.toISOString().split('T')[0];
        dataInicialInput.value = todayFormatted;
        
        // Trigger the change event to set the final date
        dataInicialInput.dispatchEvent(new Event('change'));
    }
    
    // Add loading state management for form submissions
    const forms = document.querySelectorAll('form[method="post"]');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitButton = form.querySelector('button[type="submit"]');
            const action = form.querySelector('input[name="action"]')?.value;
            
            console.log('Form submission started for action:', action);
            
            // Add loading state to button
            if (submitButton) {
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<span class="icon">‚è≥</span> Processando...';
                submitButton.disabled = true;
                
                // Restore button after 30 seconds as fallback
                setTimeout(() => {
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }, 30000);
            }
            
            // For long-running operations, show a progress message
            if (action === 'atualizarProposicoesVotadasPlenario') {
                const progressDiv = document.createElement('div');
                progressDiv.id = 'progress-message';
                progressDiv.className = 'alert alert-info mt-3';
                progressDiv.innerHTML = '<strong>‚è≥ Processando...</strong> Esta opera√ß√£o pode demorar alguns minutos. Por favor, aguarde...';
                form.appendChild(progressDiv);
            }
            
            // Allow normal form submission - remove the preventDefault
            // The Django view will handle the response properly
            console.log('Form will submit normally to Django backend');
        });
    });
    
    console.log('Form submission handlers loaded for', forms.length, 'forms');

    // Initialize Bootstrap tooltips for all elements with data-bs-toggle="tooltip"
    // This enhances native title tooltips with Bootstrap styling when available.
    try {
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(el => {
            if (window.bootstrap && bootstrap.Tooltip) {
                new bootstrap.Tooltip(el);
            }
        });
    } catch (e) {
        // If Bootstrap JS is not available, the native browser title tooltip still works.
    }
});

</script>

{% endblock %}