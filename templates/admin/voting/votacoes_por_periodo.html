{% extends "admin/voting/base_administrativo.html" %}

{% block title %}Votações por Período - VoteBem{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'gerencial:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item active">Votações por Período</li>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h3 class="mb-0">Obter votações por período (Câmara API)</h3>
    <!-- Mensagem final deve aparecer abaixo do título (em <h1>) -->
    <h1 id="final-msg" class="mt-2" style="display:none;"></h1>
  </div>
  <div class="card-body">
    <p class="text-muted">Informe as datas para buscar votações do órgão `idOrgao=180`. Ao informar a data inicial, a data final será preenchida com +88 dias automaticamente. <b>A API da Câmara dá erro se especificar mais de 3 meses.</b></p>
    <form id="form-periodo" class="row g-3" onsubmit="return false;">
      <div class="col-sm-4">
        <label for="datainicio" class="form-label">Data início</label>
        <input type="date" class="form-control" id="datainicio" name="datainicio" value="{{ default_inicio }}" required>
      </div>
      <div class="col-sm-4">
        <label for="datafim" class="form-label">Data fim</label>
       <input type="date" class="form-control" id="datafim" name="datafim" value="{{ default_fim }}" required>
        <div class="form-text">Por padrão, será preenchido com início + 88 dias.</div>
      </div>
      <div class="col-sm-4 d-flex align-items-end gap-2">
        <button id="btn-consultar" type="button" title="https://dadosabertos.camara.leg.br/api/v2/votacoes?idOrgao=180&dataInicio=<inicio>&dataFim=<fim> e lista todas as votações com 'aprovad/rejeitad', 'turno/emenda/projeto', 'total'" class="btn btn-primary">Consultar votações</button>
        <button id="btn-importar-todas" type="button" class="btn btn-success" title="Popula voting_proposicaovotacao com proposicao_id-votacao_sufixo de todas as votações listadas" disabled>Importar todas da lista</button>
      </div>
    </form>

    <div id="status" class="text-muted mt-2" aria-live="polite"></div>

    <div class="table-responsive mt-3" id="resultados" style="display:none;">
      <table class="table table-sm table-hover">
        <thead>
          <tr>
            <th>ID votação</th>
            <th>No BD</th>
            <th>Data/Hora</th>
            <th>Descrição</th>
            <th>Votação oficial</th>
          </tr>
        </thead>
        <tbody id="tbody-votacoes"></tbody>
      </table>
    </div>

    <div id="import-log" class="mt-3" style="display:none;">
      <div class="card">
        <div class="card-header">Importação de votos oficiais</div>
        <div class="card-body">
          <ul id="log-list" class="mb-0"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Utilitário: somar dias e formatar AAAA-MM-DD
  function addDaysISO(dateStr, days) {
    try {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return '';
      d.setDate(d.getDate() + days);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    } catch (_) { return ''; }
  }

  // Preenche data fim automaticamente quando início muda
  const inpInicio = document.getElementById('datainicio');
  const inpFim = document.getElementById('datafim');
  if (inpInicio) {
    inpInicio.addEventListener('change', () => {
      if (!inpFim.value) {
        const auto = addDaysISO(inpInicio.value, 88);
        if (auto) inpFim.value = auto;
      }
    });
  }

  const btnConsultar = document.getElementById('btn-consultar');
  const status = document.getElementById('status');
  // Elemento de mensagem final abaixo do título
  const finalMsg = document.getElementById('final-msg');
  const resultados = document.getElementById('resultados');
  const tbody = document.getElementById('tbody-votacoes');
  const importLog = document.getElementById('import-log');
  const logList = document.getElementById('log-list');
  const btnImportarTodas = document.getElementById('btn-importar-todas');

  // Memória: último conjunto de votações filtradas para importação sob demanda
  let lastFiltrados = [];

  // Cache local: presença e contagem de votos no BD por proposição
  // Estrutura: mapa propId -> { [sufixo]: { pvId: number, votesCount: number } }
  // Assim é possível tanto verificar se existe a votação quanto se já há votos cadastrados.
  const dbCacheByPropId = {};

  // Consulta apenas o banco para uma proposição e guarda os sufixos existentes
  async function fetchDbOnlyForProp(propId) {
    if (!propId) return {};
    if (dbCacheByPropId[propId]) return dbCacheByPropId[propId];
    const url = `${window.location.origin}/gerencial/ajax/proposicao-votacoes/?proposicao_id=${encodeURIComponent(propId)}&db_only=1`;
    try {
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      // Mapa sufixo -> info { pvId, votesCount }
      const sufixoMap = {};
      if (Array.isArray(j?.dados)) {
        for (const row of j.dados) {
          // Cada item retorna um 'id' no formato "<prop>-<sufixo>" quando vem do banco
          const fullId = row.id || row.idVotacao || '';
          let suf = null;
          try {
            if (typeof fullId === 'string' && fullId.includes('-')) {
              suf = parseInt(fullId.split('-')[1], 10);
            } else if (typeof fullId === 'number') {
              suf = fullId;
            }
          } catch (_) { suf = null; }
          if (Number.isInteger(suf)) {
            const pvId = row.pv_id || null;
            const votesCount = Number(row.votes_count || 0);
            sufixoMap[suf] = { pvId, votesCount };
          }
        }
      }
      dbCacheByPropId[propId] = sufixoMap;
      return sufixoMap;
    } catch (e) {
      // Em caso de falha, manter cache vazio para evitar re-tentativas agressivas
      dbCacheByPropId[propId] = {};
      return dbCacheByPropId[propId];
    }
  }

  // Pré-carrega presença no BD para um conjunto de proposições
  async function prefetchDbForProps(propIds) {
    const uniques = Array.from(new Set((propIds || []).filter(Boolean)));
    await Promise.all(uniques.map(pid => fetchDbOnlyForProp(pid)));
  }

  function log(msg) {
    importLog.style.display = 'block';
    const li = document.createElement('li');
    li.textContent = msg;
    logList.appendChild(li);
  }

  // Executa a mesma consulta do botão "Carregar" (por proposição), usando somente X de X-Y
  async function consultarPorProposicao(propId) {
    if (!propId) return;
    const url = `${window.location.origin}/gerencial/ajax/proposicao-votacoes/?proposicao_id=${encodeURIComponent(propId)}`;
    try {
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      const qtd = Array.isArray(j?.dados) ? j.dados.length : 0;
      log(`Proposição ${propId}: consulta realizada (${qtd} votações retornadas).`);
    } catch (e) {
      // Mostrar detalhes técnicos do erro na consulta por proposição
      const msg = (e && e.message) ? e.message : String(e);
      log(`Falha na consulta por proposição ${propId}: ${msg}. URL: ${url}`);
    }
  }

  function parseIdsFromItem(item) {
    // Extrai ID completo e também partes (proposição e sufixo) de forma robusta
    let fullId = item.id || item.idVotacao || '';
    const desc = (item.descricao || item.descrição || '').toLowerCase();
    const dataHora = item.dataHoraRegistro || item.dataHora || '';
    let propId = item.idProposicao || item.id_proposicao || null;
    let sufixo = null;
    if (typeof fullId === 'string' && fullId.includes('-')) {
      try {
        const parts = fullId.split('-');
        propId = parseInt(parts[0], 10);
        sufixo = parseInt(parts[1], 10);
      } catch (_) {}
    } else if (typeof fullId === 'number') {
      sufixo = fullId;
    } else {
      // fallback: tentar encontrar um campo de sufixo alternativo
      sufixo = item.id || item.idVotacao || null;
    }
    return { fullId, propId, sufixo, desc, dataHora };
  }

  function shouldImportByDescricao(desc) {
    //Aqui é só exibição. Para definir critérios de importação de votações,
    //  altere o step 2 da função votacao_obter_votacao no arquivo admin_views.py.
    const d = (desc || '').toLowerCase();
    return ( d.includes('aprovad') || d.includes('rejeitad') ) &&
           ( d.includes('turno') || d.includes('emenda') || d.includes('projeto') ) &&
           d.includes('total') &&
           !d.includes('requerimento');
  }

  async function importarVotos(fullId, propId, sufixo) {
    if (!propId) {
      log(`Ignorando ${fullId || sufixo}: proposicao_id ausente.`);
      return;
    }
    const url = `${window.location.origin}/gerencial/ajax/import-congress-votes/?proposicao_id=${encodeURIComponent(propId)}&votacao_id=${encodeURIComponent(fullId || '')}&consulta_id=${encodeURIComponent(sufixo || '')}`;
    try {
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const j = await r.json();
      if (!r.ok || !j.ok) {
        log(`Falha ao importar ${fullId}: ${j.error || 'erro'}${j.api_url ? ` (API: ${j.api_url})` : ''}`);
        return;
      }
      log(`Importado ${j.votacao_id}: Criados ${j.created}, Atualizados ${j.updated}, Ignorados ${j.skipped}.`);
    } catch (e) {
      // Exibe detalhes técnicos do erro de importação (HTTP/Network), incluindo URL consultada
      const msg = (e && e.message) ? e.message : String(e);
      log(`Erro ao importar ${fullId}: ${msg}. URL: ${url}`);
    }
  }

  async function consultarPeriodicamente() {
    const di = (inpInicio && inpInicio.value) ? inpInicio.value : '';
    let df = (inpFim && inpFim.value) ? inpFim.value : '';
    if (!di) { status.textContent = 'Informe a data inicial.'; return; }
    if (!df) { df = addDaysISO(di, 30); inpFim.value = df; }
    status.textContent = 'Consultando votações, aguarde...';
    // Ocultar e limpar mensagem final no início do processo
    if (finalMsg) { finalMsg.style.display = 'none'; finalMsg.textContent = ''; }
    resultados.style.display = 'none'; tbody.innerHTML = ''; logList.innerHTML = ''; importLog.style.display = 'none';
    const apiUrl = `https://dadosabertos.camara.leg.br/api/v2/votacoes?idOrgao=180&dataInicio=${encodeURIComponent(di)}&dataFim=${encodeURIComponent(df)}`;
    try {
      const resp = await fetch(apiUrl, { headers: { 'Accept': 'application/json' } });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const json = await resp.json();
      const dados = Array.isArray(json?.dados) ? json.dados : [];
      const filtrados = dados.filter(it => shouldImportByDescricao(it.descricao || it.descrição));
      status.textContent = `Foram encontradas ${dados.length} votações; ${filtrados.length} correspondem aos critérios.`;
      resultados.style.display = 'block';
      tbody.innerHTML = '';
      // Guarda conjunto para importação via botão e habilita se houver itens
      lastFiltrados = filtrados;
      if (btnImportarTodas) {
        btnImportarTodas.disabled = (lastFiltrados.length === 0);
      }
      // Antes de renderizar, pré-carregar presença no BD para cada proposição única
      const propIds = filtrados.map(it => parseIdsFromItem(it).propId).filter(Boolean);
      await prefetchDbForProps(propIds);

      // Render e disponibilizar ação de importação
      for (const item of filtrados) {
        const { fullId, propId, sufixo, desc, dataHora } = parseIdsFromItem(item);
        const sufixoMap = dbCacheByPropId[propId] || {};
        const info = (Number.isInteger(sufixo) ? sufixoMap[sufixo] : undefined) || { pvId: null, votesCount: 0 };
        const isInDb = Number.isInteger(sufixo) && !!sufixoMap[sufixo];
        const votosJaImportados = Number(info.votesCount || 0);
        const tr = document.createElement('tr');
        // Ajuste de UI: torna o número após o hífen clicável.
        // A segunda parte (sufixo) vira um link para 
        //   "<origin>/gerencial/?votacao_id=<fullId>"
        // onde <fullId> é o texto completo da célula (ex.: "2579832-105").
        // Mantemos o primeiro número (proposição) como link externo para a Câmara.
        tr.innerHTML = `<td>${(
          propId
            ? `<a target='_blank' href='https://www.camara.leg.br/proposicoesWeb/fichadetramitacao?idProposicao=${propId}'>${propId}</a>-<a href='${window.location.origin}/gerencial/?votacao_id=${encodeURIComponent(fullId)}'>${sufixo || ''}</a>`
            : `<a href='${window.location.origin}/gerencial/?votacao_id=${encodeURIComponent(fullId)}'>${sufixo || ''}</a>`
        )}</td>`+
                       `<td>${isInDb ? 'sim' : `<button type='button' class='btn btn-outline-primary btn-sm btn-abrir-gerencial' title='Abrir gerencial com votacao_id'>Abrir</button>`}</td>`+
                       `<td>${dataHora || ''}</td>`+
                       `<td>${desc || ''}</td>`+
                       `<td>${votosJaImportados > 0 ? `${votosJaImportados}` : `<button type=\"button\" class=\"btn btn-success btn-sm btn-import\">Carregar votação oficial</button>`}</td>`;
        const btn = tr.querySelector('.btn-import');
        if (btn) {
          btn.addEventListener('click', async () => {
            // Primeiro, consulta por proposição (usa apenas X de X-Y)
            await consultarPorProposicao(propId);
            // Depois, importa votos oficiais
            await importarVotos(fullId, propId, sufixo);
          });
        }
        // Se não existir no BD, permitir abrir página gerencial passando votacao_id
        const btnAbrir = tr.querySelector('.btn-abrir-gerencial');
        if (btnAbrir && fullId) {
          btnAbrir.addEventListener('click', () => {
            const targetUrl = `${window.location.origin}/gerencial/?votacao_id=${encodeURIComponent(fullId)}`;
            window.location.href = targetUrl;
          });
        }
        tbody.appendChild(tr);
      }
      // Removido: fluxo automático. Agora importação é sob demanda.
      status.textContent = 'Consulta concluída. Use o botão "Importar" para processar as votações filtradas.';
    } catch (e) {
      // Mensagem de erro com detalhes técnicos: tipo e mensagem do erro + URL da API
      const errName = e && e.name ? e.name : 'Erro';
      const errMsg = e && e.message ? e.message : String(e);
      status.textContent = `Erro ao consultar a API da Câmara: ${errName} - ${errMsg}. URL: ${apiUrl}`;
      resultados.style.display = 'none';
    }
  }

  if (btnConsultar) {
    btnConsultar.addEventListener('click', consultarPeriodicamente);
  }

  // Importação sob demanda para todas as votações filtradas da última consulta
  async function importarTodasFiltradas() {
    if (!Array.isArray(lastFiltrados) || lastFiltrados.length === 0) {
      status.textContent = 'Nenhuma votação filtrada para importar. Realize a consulta primeiro.';
      return;
    }
    // Novo comportamento: apenas popular Proposição e ProposiçãoVotação sem importar votos
    status.textContent = 'Populando Proposição e ProposiçãoVotação (sem votos), aguarde...';
    if (finalMsg) { finalMsg.style.display = 'none'; finalMsg.textContent = ''; }
    importLog.style.display = 'block';
    for (const item of lastFiltrados) {
      const { fullId, propId, sufixo } = parseIdsFromItem(item);
      // Apenas garante registros na base via endpoint de proposição-votações,
      // que insere ProposicaoVotacao quando ausente, sem persistir votos individuais.
      await consultarPorProposicao(propId);
      log(`Preparada votação ${fullId} da proposição ${propId}: Proposicao/ProposicaoVotacao garantidas. (Sem votos)`);
    }
    log('Processo concluído sem importação de votos.');
    status.textContent = 'Concluído: Proposição e ProposicaoVotacao populadas (sem votos).';
    if (finalMsg) { finalMsg.textContent = 'População de registros concluída (sem votos).'; finalMsg.style.display = ''; }
  }

  if (btnImportarTodas) {
    btnImportarTodas.addEventListener('click', importarTodasFiltradas);
  }
</script>
{% endblock %}