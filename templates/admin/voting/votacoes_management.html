{% extends "admin/voting/base_administrativo.html" %}
{% load voting_components %}

{% block title %}Gerenciamento de Votações - VoteBem{% endblock %}

{% block breadcrumb_items %}
{# Append 'Votebem' after 'Votações' per request #}
<li class="breadcrumb-item active">Gerenciamento de Votações Votebem</li>
{% endblock %}

{% block extra_css %}
<style>
    .management-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
        margin: 10px 0;
    }
    .votacoes-list {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
    }
    .create-votacao {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .votacao-item {
        padding: 10px;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .votacao-item:last-child {
        border-bottom: none;
    }
    .votacao-info h4 {
        margin: 0 0 3px 0;
        color: #495057;
        font-size: 1em;
    }
    .votacao-info small {
        color: #6c757d;
        font-size: 0.8em;
    }
    .votacao-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    .btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.8em;
        display: inline-block;
    }
    .btn-toggle {
        background: #ffc107;
        color: #212529;
    }
    .btn-edit {
        background: #007bff;
        color: white;
    }
    .btn-primary {
        background: #007bff;
        color: white;
    }
    .form-group {
        margin-bottom: 10px;
    }
    .form-group label {
        display: block;
        margin-bottom: 3px;
        font-weight: 600;
        color: #495057;
        font-size: 0.9em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .form-group textarea {
        height: 80px;
        resize: vertical;
    }
    .proposicoes-sem-votacao {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
    }
    .proposicao-item {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 0.9em;
    }
    .proposicao-item:hover {
        background: #e9ecef;
    }
    .proposicao-item:last-child {
        border-bottom: none;
    }
    .search-box {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    .results-container {
        position: relative;
    }
    .results-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ced4da;
        border-radius: 4px;
        z-index: 10;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .result-item {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        font-size: 0.9em;
    }
    .result-item:hover {
        background: #f8f9fa;
    }
    .result-empty,
    .result-hint {
        padding: 8px;
        color: #6c757d;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'gerencial:dashboard' %}" class="btn btn-secondary">Dashboard</a>
<a href="{% url 'gerencial:votacao_create' %}" class="btn btn-primary">Criar Votação Votebem</a>

{# Component bar: actions for proposição/votações (obter votações, votos oficiais, editar) #}
{% proposicao_action_bar %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="padding: 10px; margin: 10px 0; border-radius: 4px; 
             {% if message.tags == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;{% endif %}
             {% if message.tags == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div class="management-container">
    <div class="votacoes-list">
        {# Append 'Votebem' after 'Votações' #}
        <h3>Votações Votebem Existentes</h3>
        {% for votacao in votacoes %}
        <div class="votacao-item">
            <div class="votacao-info">
                <h4>
                    <a href="https://www.camara.leg.br/proposicoesWeb/fichadetramitacao?idProposicao={{ votacao.proposicao_votacao.proposicao_id }}" target="_proposicao">{{ votacao.proposicao_votacao.proposicao_id }}</a> - 
                    {{ votacao.proposicao_votacao.proposicao.tipo }} {{ votacao.proposicao_votacao.proposicao.numero }}/{{ votacao.proposicao_votacao.proposicao.ano }} - 
                    {{ votacao.titulo }}
                </h4>
                <small>
                    <ul>
                    <li><b>Resumo:</b> {{ votacao.resumo }}</li>
                    <li><b>Proposição:</b> {{ votacao.proposicao_votacao.proposicao.titulo|default:"(sem título)" }}</li>
                    <li><b>Votada em:</b> {{ votacao.proposicao_votacao.data_votacao|date:"d/m/Y H:i" }}</li>
                    </ul>
                </small>
            </div>
            <div class="votacao-actions">
                {# Button: Proposicao - abre gerencial com proposicao_id da linha #}
                {% if votacao.proposicao_votacao and votacao.proposicao_votacao.proposicao_id %}
                <a href="/gerencial/?proposicao_id={{ votacao.proposicao_votacao.proposicao_id }}" class="btn btn-primary" title="Abrir página de Proposição">
                    Proposicao
                </a>
                {% else %}
                <button class="btn btn-primary" disabled title="Proposição não identificada">Proposicao</button>
                {% endif %}
                <span class="status-badge {% if votacao.is_active_now %}status-active{% else %}status-inactive{% endif %}">
                    {% if votacao.is_active_now %}Ativa{% else %}Inativa{% endif %}
                </span>
                {# Toggle buttons removed by request #}
                <a href="{% url 'gerencial:votacao_edit' votacao.pk %}" class="btn btn-edit">Editar</a>
            </div>
        </div>
        {% empty %}
        {# Append 'Votebem' after 'votação' #}
        <p>Nenhuma votação Votebem encontrada.</p>
        {% endfor %}
    </div>

    
</div>

<div class="proposicoes-sem-votacao">
    {# Append 'Votebem' after 'Votação' #}
    <h3>Proposições sem Votação Votebem (Últimas 20)</h3>
    {% for proposicao in proposicoes_sem_votacao %}
<div class="proposicao-item" onclick="selectProposicao({{ proposicao.pk }}, '{{ proposicao.titulo|escapejs }}')">
        <strong>{{ proposicao.tipo }} {{ proposicao.numero }}/{{ proposicao.ano }}</strong><br>
        <small>{{ proposicao.titulo|truncatechars:100 }}</small>
    </div>
    {% empty %}
    {# Append 'Votebem' after 'votação' #}
    <p>Todas as proposições já possuem votação Votebem.</p>
    {% endfor %}
</div>

 

<script>
// No inline creation form here; redirect to dedicated page
</script>

{% endblock %}
