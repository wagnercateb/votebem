{% extends "admin/voting/base_administrativo.html" %}

{% block title %}Gerenciamento de Votações - VoteBem{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Gerenciamento de Votações</li>
{% endblock %}

{% block extra_css %}
<style>
    .management-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
        margin: 10px 0;
    }
    .votacoes-list {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
    }
    .create-votacao {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .votacao-item {
        padding: 10px;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .votacao-item:last-child {
        border-bottom: none;
    }
    .votacao-info h4 {
        margin: 0 0 3px 0;
        color: #495057;
        font-size: 1em;
    }
    .votacao-info small {
        color: #6c757d;
        font-size: 0.8em;
    }
    .votacao-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    .btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.8em;
        display: inline-block;
    }
    .btn-toggle {
        background: #ffc107;
        color: #212529;
    }
    .btn-edit {
        background: #007bff;
        color: white;
    }
    .btn-primary {
        background: #007bff;
        color: white;
    }
    .form-group {
        margin-bottom: 10px;
    }
    .form-group label {
        display: block;
        margin-bottom: 3px;
        font-weight: 600;
        color: #495057;
        font-size: 0.9em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .form-group textarea {
        height: 80px;
        resize: vertical;
    }
    .proposicoes-sem-votacao {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
    }
    .proposicao-item {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 0.9em;
    }
    .proposicao-item:hover {
        background: #e9ecef;
    }
    .proposicao-item:last-child {
        border-bottom: none;
    }
    .search-box {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    .results-container {
        position: relative;
    }
    .results-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ced4da;
        border-radius: 4px;
        z-index: 10;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .result-item {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        font-size: 0.9em;
    }
    .result-item:hover {
        background: #f8f9fa;
    }
    .result-empty,
    .result-hint {
        padding: 8px;
        color: #6c757d;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 10px;">
    <h1 style="margin-bottom: 3px; font-size: 1.8em;">Gerenciar Votações</h1>
    <p style="margin-bottom: 0; color: #6c757d; font-size: 0.9em;">Controle as votações ativas e crie novas votações para proposições.</p>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="padding: 10px; margin: 10px 0; border-radius: 4px; 
             {% if message.tags == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;{% endif %}
             {% if message.tags == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div class="management-container">
    <div class="votacoes-list">
        <h3>Votações Existentes</h3>
        {% for votacao in votacoes %}
        <div class="votacao-item">
            <div class="votacao-info">
                <h4>{{ votacao.titulo }}</h4>
                <small>{{ votacao.proposicao.tipo }} {{ votacao.proposicao.numero }}/{{ votacao.proposicao.ano }}</small><br>
                <small>Criada em: {{ votacao.created_at|date:"d/m/Y H:i" }}</small>
            </div>
            <div class="votacao-actions">
                <span class="status-badge {% if votacao.ativo %}status-active{% else %}status-inactive{% endif %}">
                    {% if votacao.ativo %}Ativa{% else %}Inativa{% endif %}
                </span>
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="toggle_active">
                    <input type="hidden" name="votacao_id" value="{{ votacao.id }}">
                    <button type="submit" class="btn btn-toggle">
                        {% if votacao.ativo %}Desativar{% else %}Ativar{% endif %}
                    </button>
                </form>
                <a href="{% url 'gerencial:votacao_edit' votacao.pk %}" class="btn btn-edit">Editar</a>
            </div>
        </div>
        {% empty %}
        <p>Nenhuma votação encontrada.</p>
        {% endfor %}
    </div>

    <div class="create-votacao">
        <div>
            <h3>Criar Nova Votação</h3>
            <p style="margin:0; color:#6c757d;">Use a página dedicada para criar novas votações.</p>
        </div>
        <div>
            <a href="{% url 'gerencial:votacao_create' %}" class="btn btn-primary">Ir para Criar Votação</a>
        </div>
    </div>
</div>

<div class="proposicoes-sem-votacao">
    <h3>Proposições sem Votação (Últimas 20)</h3>
    {% for proposicao in proposicoes_sem_votacao %}
    <div class="proposicao-item" onclick="selectProposicao({{ proposicao.id }}, '{{ proposicao.titulo|escapejs }}')">
        <strong>{{ proposicao.tipo }} {{ proposicao.numero }}/{{ proposicao.ano }}</strong><br>
        <small>{{ proposicao.titulo|truncatechars:100 }}</small>
    </div>
    {% empty %}
    <p>Todas as proposições já possuem votação.</p>
    {% endfor %}
</div>

<div style="margin: 30px 0; text-align: center;">
    <a href="/gerencial/dashboard/" class="btn btn-primary">Voltar ao Painel Principal</a>
</div>

<script>
// No inline creation form here; redirect to dedicated page
</script>

{% endblock %}