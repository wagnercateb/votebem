{% extends "admin/voting/base_administrativo.html" %}
{% load voting_components %}

{% block title %}Criar Nova Votação - VoteBem{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'gerencial:votacoes_management' %}">Gerenciamento de Votações</a></li>
<li class="breadcrumb-item active">Criar Nova Votação</li>
{% endblock %}

{% block extra_css %}
<style>
    .create-container { background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; }
    .form-group { margin-bottom: 10px; }
    .results-container { position: relative; }
    .results-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #dee2e6; border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 1000; }
    .result-item { padding: 6px 8px; cursor: pointer; }
    .result-item:hover { background: #f8f9fa; }
    .result-hint, .result-empty { padding: 6px 8px; color: #6c757d; }
    .search-box { width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; }
    textarea#resumo { width: 100%; min-height: 220px; resize: both; direction: ltr; text-align: left; }
    textarea#titulo { direction: ltr; text-align: left; }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 10px;">
    <h1 style="margin-bottom: 3px; font-size: 1.8em;">Criar Nova Votação Votebem{% if prefill.proposicao_id %} — Proposição {{ prefill.proposicao_id }}{% endif %}</h1>
    <p style="margin-bottom: 0; color: #6c757d; font-size: 0.9em;">Preencha os dados abaixo para criar uma votação votebem para uma votação oficial.</p>
    <div style="margin-top:8px;"><a href="{% url 'gerencial:votacoes_management' %}" class="btn btn-secondary">Voltar ao Gerenciamento</a></div>
    {# IDs e links úteis (inferidos de proposicao_id e consulta_id) #}
    <div style="margin-top:6px;">
        {% id_info %}
    </div>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="padding: 10px; margin: 10px 0; border-radius: 4px;
                 {% if message.tags == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;{% endif %}
                 {% if message.tags == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
</div>

<div class="create-container" dir="ltr">
    <form method="post">
        {% csrf_token %}

        {# Dropdown de ProposicaoVotacao sem VotacaoVoteBem, AGORA dentro do formulário para enviar no POST #}
        {% if prefill.pv_candidates %}
        <div class="form-group" style="margin-top:8px;">
            <label for="proposicao_votacao_id">Selecionar votação oficial (sem votação VoteBem disponível)</label>
            <select id="proposicao_votacao_id" name="proposicao_votacao_id" class="form-select" style="width:100%;" required>
                <option value="">Selecione...</option>
                {% for pv in prefill.pv_candidates %}
                    <option value="{{ pv.id }}" {% if prefill.selected_pv_id and pv.id == prefill.selected_pv_id %}selected{% endif %}>{{ pv.votacao_sufixo }} — {{ pv.descricao|default:"(sem descrição)" }}</option>
                {% endfor %}
            </select>
            {# Exibição do texto da opção selecionada, conforme solicitado: mostrar logo abaixo do select #}
            <i><div id="pv-selected-text" class="mt-1 text-muted" aria-live="polite"></div></i>
            <small class="text-muted">Registros em voting_proposicaovotacao ainda sem Votação Disponível ligada.</small>
        </div>
        {% endif %}

        <div class="form-group">
            <input type="hidden" name="proposicao_id" id="proposicao_id" value="{{ prefill.proposicao_id }}">
            {% if prefill.proposicao_display %}
            <div style="margin-top:6px; color:#495057;">
                <small><strong>Proposição selecionada:</strong> {{ prefill.proposicao_display }}</small>
            </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="titulo">Título da Votação Votebem *</label>
            <textarea name="titulo" id="titulo" required rows="2" style="width:100%; resize: vertical;" dir="ltr">{{ prefill.titulo }}</textarea>
        </div>

        <div class="form-group">
            <label for="resumo">Resumo *</label>
            <textarea name="resumo" id="resumo" required dir="ltr">{{ prefill.resumo }}</textarea>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="data_hora_votacao">Data/Hora da Votação Original 1*</label>
                <input type="datetime-local" id="data_hora_votacao" name="data_hora_votacao" value="{{ prefill.data_hora_votacao }}" required>
            </div>

            <div class="form-group">
                <label for="no_ar_desde">No Ar Desde *</label>
                <input type="datetime-local" id="no_ar_desde" name="no_ar_desde" value="{{ prefill.no_ar_desde }}" required>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="no_ar_ate">No Ar Até (opcional)</label>
                <input type="datetime-local" id="no_ar_ate" name="no_ar_ate" value="{{ prefill.no_ar_ate }}">
                <small class="text-muted">Deixe em branco para manter ativo indefinidamente</small>
            </div>

            <div class="form-group">
                <label>&nbsp;</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="ativo" name="ativo" {% if prefill.ativo %}checked{% endif %}>
                    <label for="ativo">Votação Ativa</label>
                </div>
            </div>
        </div>

        {# Contagens oficiais removidas do formulário: são mantidas em ProposicaoVotacao e populadas somente via import #}

        <button type="submit" class="btn btn-primary">Criar Votação</button>
    </form>
</div>

<script>
// Remove caracteres de controle bidi que podem inverter a direção do texto
function sanitizeBidi(str) {
    return (str || '').replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, '');
}
function selectProposicao(id, titulo) {
    document.getElementById('proposicao_id').value = id;
    const cleaned = sanitizeBidi(titulo);
    document.getElementById('titulo').value = 'Votação: ' + cleaned;
    const searchEl = document.getElementById('proposicao_search');
    if (searchEl) searchEl.value = cleaned;
    const dd = document.getElementById('proposicao_results');
    if (dd) dd.style.display = 'none';
}

const searchInput = document.getElementById('proposicao_search');
if (searchInput) {
searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    const dropdown = document.getElementById('proposicao_results');
    if (!dropdown) return;
    if (query.length < 3) {
        dropdown.innerHTML = '<div class="result-hint">Digite pelo menos 3 caracteres para buscar.</div>';
        dropdown.style.display = 'block';
        return;
    }
    if (window._searchTimeout) clearTimeout(window._searchTimeout);
    window._searchTimeout = setTimeout(() => {
        fetch('{% url "gerencial:ajax_proposicao_search" %}?q=' + encodeURIComponent(query))
            .then(r => r.json())
            .then(data => {
                const results = data.results || [];
                if (!results.length) {
                    dropdown.innerHTML = '<div class="result-empty">Nenhuma proposição encontrada.</div>';
                    dropdown.style.display = 'block';
                    return;
                }
                dropdown.innerHTML = results.map(r => (
                    '<div class="result-item" data-id="' + r.id + '" data-text="' + r.text.replace(/"/g, '&quot;') + '">' + r.text + '</div>'
                )).join('');
                dropdown.style.display = 'block';
                dropdown.querySelectorAll('.result-item').forEach(el => {
                    el.addEventListener('click', () => {
                        const id = el.getAttribute('data-id');
                        const text = sanitizeBidi(el.getAttribute('data-text'));
                        document.getElementById('proposicao_id').value = id;
                        document.getElementById('titulo').value = 'Votação: ' + text;
                        const si = document.getElementById('proposicao_search');
                        if (si) si.value = text;
                        dropdown.style.display = 'none';
                    });
                });
            })
            .catch(() => {
                dropdown.innerHTML = '<div class="result-empty">Erro ao buscar proposições.</div>';
                dropdown.style.display = 'block';
            });
    }, 300);
});
}

document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('proposicao_results');
    const input = document.getElementById('proposicao_search');
    if (!dropdown || !input) return;
    if (!dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
    }
});

// Exibir o botão de criação somente se uma votação oficial for selecionada
// Aplica-se quando a lista de pv_candidates está presente
document.addEventListener('DOMContentLoaded', function() {
    const pvSelect = document.getElementById('proposicao_votacao_id');
    const submitBtn = document.querySelector('button[type="submit"]');
    const pvSelectedText = document.getElementById('pv-selected-text');
    if (pvSelect && submitBtn) {
        // Atualiza exibição: botão de submit e descrição da opção abaixo do select
        const updateUI = () => {
            // Mostrar ou ocultar o botão de criar
            submitBtn.style.display = pvSelect.value ? 'inline-block' : 'none';
            // Mostrar o texto da opção selecionada logo abaixo do select
            if (pvSelectedText) {
                if (pvSelect.value && pvSelect.selectedIndex >= 0) {
                    // Usa o texto visível da option (ex.: "62 — Aprovado ...")
                    const opt = pvSelect.options[pvSelect.selectedIndex];
                    pvSelectedText.textContent = sanitizeBidi(opt ? opt.text : '');
                } else {
                    pvSelectedText.textContent = '';
                }
            }
        };
        // Inicializa UI ao carregar (inclui caso preselected via GET: consulta_id)
        updateUI();
        // Atualiza ao trocar a opção
        pvSelect.addEventListener('change', updateUI);
    }
});
</script>

{% endblock %}