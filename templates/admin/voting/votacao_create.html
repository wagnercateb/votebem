{% extends "admin/voting/base_administrativo.html" %}

{% block title %}Criar Nova Votação - VoteBem{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'gerencial:votacoes_management' %}">Gerenciamento de Votações</a></li>
<li class="breadcrumb-item active">Criar Nova Votação</li>
{% endblock %}

{% block extra_css %}
<style>
    .create-container { background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; }
    .form-group { margin-bottom: 10px; }
    .results-container { position: relative; }
    .results-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #dee2e6; border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 1000; }
    .result-item { padding: 6px 8px; cursor: pointer; }
    .result-item:hover { background: #f8f9fa; }
    .result-hint, .result-empty { padding: 6px 8px; color: #6c757d; }
    .search-box { width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; }
    textarea#resumo { width: 100%; min-height: 220px; resize: both; }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 10px;">
    <h1 style="margin-bottom: 3px; font-size: 1.8em;">Criar Nova Votação</h1>
    <p style="margin-bottom: 0; color: #6c757d; font-size: 0.9em;">Preencha os dados abaixo para criar uma votação para uma proposição.</p>
    <div style="margin-top:8px;"><a href="{% url 'gerencial:votacoes_management' %}" class="btn btn-secondary">Voltar ao Gerenciamento</a></div>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="padding: 10px; margin: 10px 0; border-radius: 4px;
                 {% if message.tags == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;{% endif %}
                 {% if message.tags == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
</div>

<div class="create-container">
    <form method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="proposicao_search">Buscar Proposição:</label>
            <div class="results-container">
                <input type="text" id="proposicao_search" class="search-box" placeholder="Digite para buscar proposições..." value="{{ prefill.proposicao_search }}">
                <div id="proposicao_results" class="results-dropdown" style="display:none;"></div>
            </div>
            <input type="hidden" name="proposicao_id" id="proposicao_id" value="{{ prefill.proposicao_id }}">
            {% if prefill.proposicao_display %}
            <div style="margin-top:6px; color:#495057;">
                <small><strong>Proposição selecionada:</strong> {{ prefill.proposicao_display }}</small>
            </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="titulo">Título da Votação *</label>
            <input type="text" name="titulo" id="titulo" required maxlength="500" value="{{ prefill.titulo }}">
        </div>

        <div class="form-group">
            <label for="resumo">Resumo *</label>
            <textarea name="resumo" id="resumo" required>{{ prefill.resumo }}</textarea>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="data_hora_votacao">Data/Hora da Votação Original *</label>
                <input type="datetime-local" id="data_hora_votacao" name="data_hora_votacao" value="{{ prefill.data_hora_votacao }}" required>
            </div>

            <div class="form-group">
                <label for="no_ar_desde">No Ar Desde *</label>
                <input type="datetime-local" id="no_ar_desde" name="no_ar_desde" value="{{ prefill.no_ar_desde }}" required>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="no_ar_ate">No Ar Até (opcional)</label>
                <input type="datetime-local" id="no_ar_ate" name="no_ar_ate" value="{{ prefill.no_ar_ate }}">
                <small class="text-muted">Deixe em branco para manter ativo indefinidamente</small>
            </div>

            <div class="form-group">
                <label>&nbsp;</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="ativo" name="ativo" {% if prefill.ativo %}checked{% endif %}>
                    <label for="ativo">Votação Ativa</label>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="sim_oficial">Votos SIM Oficiais</label>
                <input type="number" id="sim_oficial" name="sim_oficial" min="0" value="{{ prefill.sim_oficial }}">
            </div>

            <div class="form-group">
                <label for="nao_oficial">Votos NÃO Oficiais</label>
                <input type="number" id="nao_oficial" name="nao_oficial" min="0" value="{{ prefill.nao_oficial }}">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Criar Votação</button>
    </form>
</div>

<script>
function selectProposicao(id, titulo) {
    document.getElementById('proposicao_id').value = id;
    document.getElementById('titulo').value = 'Votação: ' + titulo;
    document.getElementById('proposicao_search').value = titulo;
    const dd = document.getElementById('proposicao_results');
    if (dd) dd.style.display = 'none';
}

document.getElementById('proposicao_search').addEventListener('input', function() {
    const query = this.value.trim();
    const dropdown = document.getElementById('proposicao_results');
    if (!dropdown) return;
    if (query.length < 3) {
        dropdown.innerHTML = '<div class="result-hint">Digite pelo menos 3 caracteres para buscar.</div>';
        dropdown.style.display = 'block';
        return;
    }
    if (window._searchTimeout) clearTimeout(window._searchTimeout);
    window._searchTimeout = setTimeout(() => {
        fetch('{% url "gerencial:ajax_proposicao_search" %}?q=' + encodeURIComponent(query))
            .then(r => r.json())
            .then(data => {
                const results = data.results || [];
                if (!results.length) {
                    dropdown.innerHTML = '<div class="result-empty">Nenhuma proposição encontrada.</div>';
                    dropdown.style.display = 'block';
                    return;
                }
                dropdown.innerHTML = results.map(r => (
                    '<div class="result-item" data-id="' + r.id + '" data-text="' + r.text.replace(/"/g, '&quot;') + '">' + r.text + '</div>'
                )).join('');
                dropdown.style.display = 'block';
                dropdown.querySelectorAll('.result-item').forEach(el => {
                    el.addEventListener('click', () => {
                        const id = el.getAttribute('data-id');
                        const text = el.getAttribute('data-text');
                        document.getElementById('proposicao_id').value = id;
                        document.getElementById('titulo').value = 'Votação: ' + text;
                        document.getElementById('proposicao_search').value = text;
                        dropdown.style.display = 'none';
                    });
                });
            })
            .catch(() => {
                dropdown.innerHTML = '<div class="result-empty">Erro ao buscar proposições.</div>';
                dropdown.style.display = 'block';
            });
    }, 300);
});

document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('proposicao_results');
    const input = document.getElementById('proposicao_search');
    if (!dropdown || !input) return;
    if (!dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
    }
});
</script>

{% endblock %}