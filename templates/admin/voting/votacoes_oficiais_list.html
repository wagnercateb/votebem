{% extends 'admin/voting/base_administrativo.html' %}

{% comment %}
Tela administrativa: lista entradas de `voting_proposicaovotacao` (ProposicaoVotacao)
com contagem de registros relacionados em `voting_congressmanvote` (CongressmanVote).

Cada linha representa uma vota√ß√£o oficial associada a uma proposi√ß√£o e exibe:
- Identifica√ß√£o da proposi√ß√£o (tipo, n√∫mero/ano) e t√≠tulo
- Sufixo da vota√ß√£o (`votacao_sufixo`)
- Data/Hora de registro da vota√ß√£o (`data_votacao`), quando dispon√≠vel
- Descri√ß√£o da vota√ß√£o
- Contagem de votos individuais oficiais (CongressmanVote) relacionados

Observa√ß√£o: esta √© uma listagem de leitura focada em inspe√ß√£o r√°pida dos dados
obtidos de vota√ß√µes oficiais. A edi√ß√£o √© realizada via Django Admin ou telas espec√≠ficas.
{% endcomment %}

{% block title %}Vota√ß√µes oficiais obtidas - Painel Administrativo{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/gerencial/dashboard/">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Vota√ß√µes oficiais obtidas</li>
  </ol>
  <div class="mb-2">
    <a href="/gerencial/dashboard/" class="btn btn-secondary">Voltar ao Dashboard</a>
    <form method="post" style="display: inline; margin-left: 8px;">
      {% csrf_token %}
      <input type="hidden" name="action" value="loopObterVotacoes">
      <button type="submit" class="btn btn-primary" title="Insere vota√ß√µes em voting_proposicaovotacao para proposi√ß√µes de voting_proposicao, do ano informado, que ainda N√ÉO possuem votos em CongressmanVote" data-bs-toggle="tooltip" data-bs-placement="top" style="vertical-align: middle;">
        <span class="icon">üîÑ</span> Obter Vota√ß√µes no Ano:
      </button>
      <input type="number" id="anoVotacaoInline" name="anoVotacao" min="1900" max="2100" value="{{ current_year }}" class="form-control" style="width: 90px; display: inline-block; vertical-align: middle;" title="Filtra por proposi√ß√µes do ano informado. O loop ignora qualquer vota√ß√£o oficial que j√° tenha votos individuais registrados." data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Filtra por proposi√ß√µes do ano informado. O loop ignora qualquer vota√ß√£o oficial que j√° tenha votos individuais registrados.">
    </form>
  </div>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h2>Vota√ß√µes oficiais obtidas</h2>
    <p class="text-muted">
      Lista gerada a partir da tabela <code>voting_proposicaovotacao</code> com a contagem de
      votos individuais oficiais (<code>voting_congressmanvote</code>) associados a cada vota√ß√£o.
    </p>

    <!-- Barra de controles (topo): filtro por m√∫ltiplas palavras e tamanho da p√°gina (client-side)
         - O filtro aceita v√°rias palavras separadas por espa√ßo e busca em TODO o conte√∫do textual da linha
         - O controle de tamanho de p√°gina redefine a pagina√ß√£o CLIENT-SIDE desta tabela renderizada -->
    <div class="d-flex align-items-center gap-2 mb-2" id="vb-top-controls">

      <label for="vb-filter" class="form-label mb-0">Filtro:</label>
      <input id="vb-filter" type="text" class="form-control" style="max-width: 280px;" placeholder="Ex.: urg√™ncia 2025 rejeitado">

      <label for="vb-page-size" class="form-label mb-0" style="margin-left: 12px;">Linhas por p√°gina:</label>
      <select id="vb-page-size" class="form-select" style="max-width: 120px;">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="0">Todas</option>
      </select>

      <nav aria-label="P√°gina de resultados" class="mt-3" id="vb-pagination-nav">
        <ul class="pagination" id="vb-pagination">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}

          <li class="page-item active"><span class="page-link">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Pr√≥xima</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Pr√≥xima</span></li>
          {% endif %}
        </ul>
      </nav>
    
    </div>


    <div class="table-responsive">
      <table class="table table-striped table-hover" id="vb-votacoes-table">
        <thead>
          <tr>
            <th>#id</th>
            <th>Proposi√ß√£o</th>
            <th>Votebem</th>
            <th>Data/Hora registro</th>
            <th>Descri√ß√£o</th>
            <th>Votos individuais oficiais</th>
          </tr>
        </thead>
        <tbody>
          {% for pv in page_obj %}
          <tr>
            <td>{{ pv.id }}</td>
            <td>
              {% if pv.proposicao %}
                <strong>{{ pv.proposicao.tipo }} {{ pv.proposicao.numero }}/{{ pv.proposicao.ano }}</strong><br>
                {% with vb=pv.votacaovotebem.all|first %}
                  {% if vb %}
                    <small>{{ vb.titulo }}</small>
                  {% endif %}
                {% endwith %}
              {% else %}
                ‚Äî
              {% endif %}
            </td>
            <td>
              {# Coluna "Votebem": link para editar a VotacaoVoteBem existente; se n√£o existir, oferece cria√ß√£o #}
              {% with vb=pv.votacaovotebem.all|first %}
                {% if vb %}
                  <a href="{% url 'gerencial:votacao_edit' pk=vb.id %}">Editar Votebem #{{ vb.id }}</a>
                {% elif pv.congressman_votes_count == 0 %}
                  {# Link de cria√ß√£o pr√©-preenchida: mant√©m navega√ß√£o para criar Votebem e pr√©-seleciona a vota√ß√£o oficial #}
                  <a href="{% url 'gerencial:votacao_create' %}?proposicao_id={{ pv.proposicao.id_proposicao }}&consulta_id={{ pv.proposicao.id_proposicao }}-{{ pv.votacao_sufixo }}">Criar p/ sufixo {{pv.votacao_sufixo}} </a>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% if pv.data_votacao %}
                {{ pv.data_votacao|date:"d/m/Y H:i" }}
              {% else %}
                ‚Äî
              {% endif %}
            </td>
            <td>{{ pv.descricao|default:"(sem descri√ß√£o)" }}</td>
            <td>
              <!-- 
                Coluna "Votos individuais oficiais":
                - Se a contagem for maior que zero, apenas exibe o n√∫mero.
                - Se for zero, oferece um bot√£o para importar diretamente os votos oficiais
                  para esta vota√ß√£o, chamando o mesmo endpoint utilizado na p√°gina /gerencial/.
                - O bot√£o envia (proposicao_id, consulta_id) onde consulta_id √© o sufixo da vota√ß√£o,
                  resultando em uma chamada √† API da C√¢mara no formato
                  https://dadosabertos.camara.leg.br/api/v2/votacoes/<proposicao_id>-<sufixo>/votos
              -->
              {% if pv.congressman_votes_count|default:0 %}
                {{ pv.congressman_votes_count|default:0 }}
              {% else %}
                <span class="text-muted">0</span>
                <button type="button"
                        class="btn btn-sm btn-success vb-btn-import-votos"
                        data-proposicao-id="{{ pv.proposicao.id_proposicao }}"
                        data-consulta-sufixo="{{ pv.votacao_sufixo }}"
                        title="Importar votos oficiais desta vota√ß√£o">
                  Carregar votos oficiais
                </button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted">Nenhuma vota√ß√£o oficial encontrada.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>


  </div>
 </div>
{% endblock %}

{% block extra_js %}
<script>
  // --- Filtro e pagina√ß√£o client-side para a tabela de vota√ß√µes oficiais ---
  (function(){
    // Elementos principais
    const table = document.getElementById('vb-votacoes-table');
    const tbody = table ? table.querySelector('tbody') : null;
    const filterInput = document.getElementById('vb-filter');
    const pageSizeSel = document.getElementById('vb-page-size');
    const pagUl = document.getElementById('vb-pagination');
    const pagNav = document.getElementById('vb-pagination-nav');

    // Estado em mem√≥ria
    let allRows = [];
    let filteredRows = [];
    let currentPage = 1;
    let pageSize = 20; // padr√£o

    // --- Util: extrai o texto concatenado de uma linha, em min√∫sculas
    function rowTextLower(tr) {
      // Concatena texto dos n√≥s descendentes para capturar todo conte√∫do vis√≠vel
      return (tr.textContent || '').toLowerCase();
    }

    // --- Aplica filtro multi-palavra sobre o texto completo da linha
    function applyFilter() {
      const query = (filterInput && filterInput.value ? filterInput.value : '').toLowerCase().trim();
      const tokens = query.split(/\s+/).filter(Boolean);
      if (tokens.length === 0) {
        filteredRows = allRows.slice();
      } else {
        filteredRows = allRows.filter(tr => {
          const txt = rowTextLower(tr);
          // Mant√©m a linha apenas se TODAS as palavras forem encontradas em algum lugar da linha
          return tokens.every(t => txt.includes(t));
        });
      }
      // Ap√≥s filtrar, volte para a primeira p√°gina
      currentPage = 1;
      render();
    }

    // --- Renderiza linhas conforme p√°gina e atualiza pagina√ß√£o (li/span/a)
    function render() {
      if (!tbody) return;
      // Oculta todas as linhas inicialmente
      allRows.forEach(tr => { tr.style.display = 'none'; });

      // Se pageSize = 0 => "Todas"
      const ps = Number(pageSize) || 0;
      const total = filteredRows.length;
      const totalPages = ps > 0 ? Math.max(1, Math.ceil(total / ps)) : 1;
      // Corrige currentPage dentro do intervalo
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages) currentPage = totalPages;

      let startIdx = 0;
      let endIdx = total; // exclusivo
      if (ps > 0) {
        startIdx = (currentPage - 1) * ps;
        endIdx = Math.min(startIdx + ps, total);
      }

      // Exibe apenas o intervalo da p√°gina atual
      for (let i = startIdx; i < endIdx; i++) {
        const tr = filteredRows[i];
        if (tr) tr.style.display = '';
      }

      // Atualiza UI de pagina√ß√£o
      updatePaginationUI(totalPages);
    }

    // --- Constr√≥i/atualiza itens de pagina√ß√£o com li/span/a
    function updatePaginationUI(totalPages) {
      if (!pagUl) return;
      // Limpa pagina√ß√£o atual (substitui pela client-side)
      pagUl.innerHTML = '';

      // Bot√£o "Anterior"
      const prevLi = document.createElement('li');
      prevLi.className = 'page-item' + (currentPage > 1 ? '' : ' disabled');
      const prevA = document.createElement(currentPage > 1 ? 'a' : 'span');
      prevA.className = 'page-link';
      prevA.textContent = 'Anterior';
      if (currentPage > 1) {
        prevA.href = '#';
        prevA.addEventListener('click', function(ev){ ev.preventDefault(); currentPage--; render(); });
      }
      prevLi.appendChild(prevA);
      pagUl.appendChild(prevLi);

      // Indicador "P√°gina X de Y"
      const midLi = document.createElement('li');
      midLi.className = 'page-item active';
      const midSpan = document.createElement('span');
      midSpan.className = 'page-link';
      midSpan.textContent = 'P√°gina ' + currentPage + ' de ' + totalPages;
      midLi.appendChild(midSpan);
      pagUl.appendChild(midLi);

      // Bot√£o "Pr√≥xima"
      const nextLi = document.createElement('li');
      nextLi.className = 'page-item' + (currentPage < totalPages ? '' : ' disabled');
      const nextA = document.createElement(currentPage < totalPages ? 'a' : 'span');
      nextA.className = 'page-link';
      nextA.textContent = 'Pr√≥xima';
      if (currentPage < totalPages) {
        nextA.href = '#';
        nextA.addEventListener('click', function(ev){ ev.preventDefault(); currentPage++; render(); });
      }
      nextLi.appendChild(nextA);
      pagUl.appendChild(nextLi);
    }

    // --- Inicializa√ß√£o: coleta linhas e liga eventos
    function init() {
      if (!tbody) return;
      // Coleta todas as TRs atuais (linhas renderizadas pelo servidor)
      allRows = Array.from(tbody.querySelectorAll('tr'));
      filteredRows = allRows.slice();

      // Define tamanho de p√°gina inicial a partir do seletor (ou padr√£o)
      if (pageSizeSel) {
        pageSize = Number(pageSizeSel.value) || 20;
        pageSizeSel.addEventListener('change', function(){
          pageSize = Number(pageSizeSel.value) || 0; // 0 => Todas
          currentPage = 1;
          render();
        });
      }

      // Liga filtro incremental (input/change)
      if (filterInput) {
        filterInput.addEventListener('input', applyFilter);
        filterInput.addEventListener('change', applyFilter);
      }

      // Primeira renderiza√ß√£o
      render();
    }

    document.addEventListener('DOMContentLoaded', init);
  })();

  // --- Importa√ß√£o de votos oficiais (mesma a√ß√£o do bot√£o em /gerencial/) ---
  (function(){
    // Este bloco adiciona comportamento ao bot√£o "Carregar votos oficiais" exibido
    // apenas quando a contagem de votos oficiais individuais √© zero.
    // A a√ß√£o dispara uma requisi√ß√£o GET para o endpoint interno:
    //   /gerencial/ajax/import-congress-votes/?proposicao_id=...&consulta_id=...
    // O backend utiliza estes par√¢metros para consultar a API da C√¢mara em:
    //   https://dadosabertos.camara.leg.br/api/v2/votacoes/<proposicao_id>-<sufixo>/votos
    // Ap√≥s concluir, recarregamos a p√°gina para refletir a contagem atualizada.

    // Utilit√°rio: Alterna estado de carregamento usando o pr√≥prio bot√£o
    // - Altera o texto para "Importando..." e desabilita para evitar cliques repetidos
    // - Restaura texto original e habilita em caso de erro
    function setLoading(btn, isLoading) {
      if (!btn) return;
      if (isLoading) {
        if (!btn.dataset.originalText) btn.dataset.originalText = btn.textContent || 'Carregar votos oficiais';
        btn.textContent = 'Importando...';
        btn.disabled = true;
      } else {
        const orig = btn.dataset.originalText || 'Carregar votos oficiais';
        btn.textContent = orig;
        btn.disabled = false;
      }
    }

    function bindImportButtons() {
      const buttons = document.querySelectorAll('.vb-btn-import-votos');
      buttons.forEach(function(btn){
        btn.addEventListener('click', function(ev){
          ev.preventDefault();
          // Extrai par√¢metros necess√°rios da linha atual
          const propId = btn.getAttribute('data-proposicao-id') || '';
          const sufixo = btn.getAttribute('data-consulta-sufixo') || '';
          if (!propId || !sufixo) {
            alert('Par√¢metros faltando: verifique proposicao_id e sufixo da vota√ß√£o.');
            return;
          }
          // Ativa estado de carregamento no bot√£o
          setLoading(btn, true);

          // Monta URL interna que dispara a importa√ß√£o (mesmo endpoint usado em /gerencial/)
          const url = `${window.location.origin}/gerencial/ajax/import-congress-votes/?proposicao_id=${encodeURIComponent(propId)}&consulta_id=${encodeURIComponent(sufixo)}`;

          // Opcional: log para depura√ß√£o, incluindo a URL p√∫blica da C√¢mara
          // Exemplo de voto: https://dadosabertos.camara.leg.br/api/v2/votacoes/1197773-140/votos
          console.debug('Importando votos oficiais via:', url,
                        'API C√¢mara:', `https://dadosabertos.camara.leg.br/api/v2/votacoes/${propId}-${sufixo}/votos`);

          fetch(url, { headers: { 'Accept': 'application/json' } })
            .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
            .then(resp => {
              if (!resp.ok || !resp.body?.ok) {
                const apiUrl = resp.body?.api_url || '';
                setLoading(btn, false);
                alert('Erro ao importar votos.' + (apiUrl ? `\nURL: ${apiUrl}` : ''));
                return;
              }
              // Sucesso: recarrega a p√°gina para atualizar a contagem no servidor
              window.location.reload();
            })
            .catch(function(e){
              setLoading(btn, false);
              alert('Falha de rede ao importar votos. Tente novamente.');
            });
        });
      });
    }

    document.addEventListener('DOMContentLoaded', bindImportButtons);
  })();
</script>
<script>
  // Inicializa tooltips do Bootstrap para todos os elementos com data-bs-toggle="tooltip"
  // Mant√©m comportamento nativo de "title" como fallback caso Bootstrap n√£o esteja dispon√≠vel.
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (el) {
        if (window.bootstrap && bootstrap.Tooltip) {
          new bootstrap.Tooltip(el);
        }
      });
    } catch (e) {
      // Se Bootstrap JS n√£o estiver carregado, o tooltip nativo (title) ainda funciona.
    }
  });
</script>
{% endblock %}