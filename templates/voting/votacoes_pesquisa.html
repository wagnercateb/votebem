{% extends 'base.html' %}
{% block title %}{% if is_proposicoes %}Pesquisar Proposições da Câmara dos Deputados{% else %}Pesquisar Votações de Votebem.online{% endif %}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>
        <i class="bi bi-search"></i>
        {% if is_proposicoes %}Pesquisar Proposições da Câmara dos Deputados{% else %}Pesquisar Votações de Votebem.online{% endif %}
      </h2>
      <div class="d-flex gap-2">
        {% if is_proposicoes %}
          <a href="{% url 'voting:votacoes_pesquisa' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Pesquisar Votações de Votebem.online
          </a>
        {% else %}
          <!-- Botão solicitado para pesquisar proposições -->
          <a href="{% url 'voting:votacoes_pesquisa' %}?target=proposicoes" class="btn btn-outline-primary">
            <i class="bi bi-building"></i> Pesquisar Proposições da Câmara dos Deputados
          </a>
        {% endif %}
        <a href="{% url 'voting:votacoes_disponiveis' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Voltar às Votações
        </a>
      </div>
    </div>

    <form method="get" class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-8">
            <div class="input-group">
              <label for="q" class="input-group-text">Pesquisar</label>
              <input type="text" id="q" name="q" value="{{ q }}" class="form-control" placeholder="Título, resumo, ementa..." aria-label="Pesquisar">
            </div>
          </div>
        </div>
      </div>
    </form>

    {% if votacoes %}
      <div class="card">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              {% if is_proposicoes %}
              <tr>
                <th>Título</th>
                <th>Proposição</th>
                <th>Ementa</th>
                <th>Ações</th>
              </tr>
              {% else %}
              <tr>
                <th>Título</th>
                <th>Ativa</th>
                <th>No ar desde</th>
                <th>Ações</th>
              </tr>
              {% endif %}
            </thead>
            <tbody>
              {% for v in votacoes %}
              {% if is_proposicoes %}
              <tr>
                <td>
                  {% if v.id_proposicao %}
                    <a href="http://www.camara.gov.br/proposicoesWeb/fichadetramitacao?idProposicao={{ v.id_proposicao }}" target="camara" class="text-decoration-none">
                      {{ v.titulo|truncatechars:80 }}
                    </a>
                  {% else %}
                    {{ v.titulo|truncatechars:80 }}
                  {% endif %}
                </td>
                <td>
                  {% if v.id_proposicao %}
                    <a href="http://www.camara.gov.br/proposicoesWeb/fichadetramitacao?idProposicao={{ v.id_proposicao }}" target="camara" class="text-decoration-none">
                      <span class="badge bg-primary">{{ v.tipo }} {{ v.numero }}/{{ v.ano }}</span>
                    </a>
                  {% else %}
                    <span class="badge bg-primary">{{ v.tipo }} {{ v.numero }}/{{ v.ano }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="text-muted small">{{ v.ementa|truncatechars:120 }}</div>
                </td>
                <td>
                  {% if v.id_proposicao %}
                  <a href="http://www.camara.gov.br/proposicoesWeb/fichadetramitacao?idProposicao={{ v.id_proposicao }}" class="btn btn-sm btn-outline-primary" target="camara">
                    <i class="bi bi-box-arrow-up-right"></i> Câmara
                  </a>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td>
                  {% if v.proposicao_votacao and v.proposicao_votacao.proposicao and v.proposicao_votacao.proposicao.id_proposicao %}
                    <a href="http://www.camara.gov.br/proposicoesWeb/fichadetramitacao?idProposicao={{ v.proposicao_votacao.proposicao.id_proposicao }}" target="camara" class="text-decoration-none">
                      {{ v.titulo|truncatechars:80 }}
                    </a>
                  {% else %}
                    {{ v.titulo|truncatechars:80 }}
                  {% endif %}
                  <div class="text-muted small">{{ v.resumo|truncatechars:120 }}</div>
                </td>
                <td>
                  {% if v.ativo %}
                    <span class="badge bg-success">Sim</span>
                  {% else %}
                    <span class="badge bg-secondary">Não</span>
                  {% endif %}
                </td>
                <td>{{ v.no_ar_desde|date:"d/m/Y H:i" }}</td>
                <td>
                  <a href="{% url 'voting:votacao_detail' v.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> Detalhes
                  </a>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if is_paginated %}
        <div class="card-footer">
          <nav aria-label="Navegação">
            <ul class="pagination justify-content-center mb-0">
              {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1{% if q %}&q={{ q }}{% endif %}{% if tipo_sel %}&tipo={{ tipo_sel }}{% endif %}{% if ano_sel %}&ano={{ ano_sel }}{% endif %}{% if ativo_sel %}&ativo={{ ativo_sel }}{% endif %}">&laquo; Primeira</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if tipo_sel %}&tipo={{ tipo_sel }}{% endif %}{% if ano_sel %}&ano={{ ano_sel }}{% endif %}{% if ativo_sel %}&ativo={{ ativo_sel }}{% endif %}">Anterior</a></li>
              {% endif %}
              <li class="page-item active"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
              {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if tipo_sel %}&tipo={{ tipo_sel }}{% endif %}{% if ano_sel %}&ano={{ ano_sel }}{% endif %}{% if ativo_sel %}&ativo={{ ativo_sel }}{% endif %}">Próxima</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}{% if tipo_sel %}&tipo={{ tipo_sel }}{% endif %}{% if ano_sel %}&ano={{ ano_sel }}{% endif %}{% if ativo_sel %}&ativo={{ ativo_sel }}{% endif %}">Última &raquo;</a></li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        {% if is_proposicoes %}
          <h3 class="text-muted mt-3">Nenhuma proposição encontrada</h3>
          <p class="text-muted">Ajuste os filtros para encontrar outras proposições.</p>
        {% else %}
          <h3 class="text-muted mt-3">Nenhuma votação encontrada</h3>
          <p class="text-muted">Ajuste os filtros para encontrar outras votações.</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
 </div>
{% endblock %}

{% block extra_js %}
<!--
  Aplicação imediata dos filtros na página de pesquisa:
  - Todos os selects (Tipo, Ano, Ativa) disparam o envio do formulário ao mudar.
  - O input de texto (q) também dispara o envio imediatamente ao digitar.
  Observações:
  - Método GET: os parâmetros são enviados na URL, permitindo bookmarking/compartilhamento.
  - Não há debounce por solicitação de "imediato"; podemos adicionar no futuro se necessário.
-->
<script>
  (function() {
    'use strict';

    /**
     * Localiza o formulário principal da página de pesquisa.
     * @returns {HTMLFormElement|null}
     */
    function getSearchForm() {
      return document.querySelector('form.card.mb-4');
    }

    // ===== Client-side filtering helpers (accent- and case-insensitive) =====
    function normalizeText(s) {
      return (s || '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase();
    }

    function tokenize(raw) {
      return normalizeText(raw)
        .trim()
        .split(/\s+/)
        .filter(Boolean);
    }

    function applyFilter() {
      var form = getSearchForm();
      if (!form) return;
      var qInput = form.querySelector('input[name="q"]');
      var rows = document.querySelectorAll('table.table tbody tr');
      if (!qInput || rows.length === 0) return;

      var tokens = tokenize(qInput.value);
      if (tokens.length === 0) {
        rows.forEach(function(tr) { tr.style.display = ''; });
        return;
      }

      rows.forEach(function(tr) {
        var text = normalizeText(tr.innerText || '');
        var matchesAll = tokens.every(function(tok) { return text.indexOf(tok) !== -1; });
        tr.style.display = matchesAll ? '' : 'none';
      });
    }

    /**
     * Envia o formulário imediatamente.
     * Usa requestSubmit quando disponível para respeitar validações nativas.
     */
    function submitFormImmediate() {
      var form = getSearchForm();
      if (!form) return;
      if (typeof form.requestSubmit === 'function') {
        form.requestSubmit();
      } else {
        form.submit();
      }
    }

    /**
     * Inicializa listeners em selects e no input de texto.
     */
    function initImmediateFilters() {
      var form = getSearchForm();
      if (!form) return;

      // Input de pesquisa (q)
      var qInput = form.querySelector('input[name="q"]');
      if (qInput) {
        // Prevent Enter from submitting; keep UX purely client-side.
        qInput.addEventListener('keydown', function(ev) {
          if (ev.key === 'Enter') ev.preventDefault();
        });
        // Apply multi-word AND filter in real time.
        qInput.addEventListener('input', applyFilter);
        // Initial filter to reflect preloaded value.
        applyFilter();
      }

      // Todos os selects presentes na página (tipo, ano e, quando aplicável, ativo)
      var selects = form.querySelectorAll('select');
      // Selects no longer submit; text input drives client-side filtering.
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initImmediateFilters);
    } else {
      initImmediateFilters();
    }
  })();
</script>
{% endblock %}
