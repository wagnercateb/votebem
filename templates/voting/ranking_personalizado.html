{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load voting_components %}

{% block title %}Ranking Personalizado{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="topo-pagina intro-lead-in text-center mb-4">
                <h1>Ranking de Congressistas</h1>
                <p class="lead">Veja quem melhor te representa (quem vota mais parecido com você)</p>
            </div>
        </div>
    </div>

    {# If no selection has been made yet, prompt the user #}
    {% if not all_selected and selected_ufs|length == 0 %}
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="alert alert-info text-center">
                <h4>Selecione seu estado</h4>
                <p>Para ver o ranking personalizado, escolha um ou mais estados.
                   Você também pode selecionar todos os estados.</p>
                
                <!-- Estados selector (badges) -->
                <div class="text-left">
                    <div id="uf-badges-initial" class="d-flex flex-wrap mb-3">
                        {# Render one badge per estado (UF) - default unselected, black text #}
                        {% for uf in available_ufs %}
                            <span class="badge badge-pill badge-light border text-dark mr-2 mb-2 uf-badge" data-uf="{{ uf }}" style="cursor:pointer; color:#000;">
                                {{ uf }}
                            </span>
                        {% endfor %}
                        {# "Todos" badge to toggle all or none - default unselected #}
                        <span id="uf-badge-all-initial" class="badge badge-pill badge-light border text-dark mr-2 mb-2" style="cursor:pointer; color:#000;">Todos</span>
                    </div>
                    <button id="btn-apply-initial" class="btn btn-primary">Atualizar</button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    
    <div class="row mb-4">
        <div class="col-md-6">
            {% if all_selected %}
                <h3>Congressistas de todos os estados</h3>
            {% else %}
                <h3>Congressistas de {{ selected_ufs|join:", " }}</h3>
            {% endif %}
            <p class="text-muted">Ranking baseado na compatibilidade com seus votos</p>
        </div>
        <div class="col-md-6 text-right">
            <!-- Estados selector (badges) -->
            <div id="uf-badges" class="d-inline-flex flex-wrap align-items-center justify-content-end">
                {% for uf in available_ufs %}
                    <span class="{% if selected_ufs and uf in selected_ufs %}btn btn-sm btn-primary rounded-pill{% else %}badge badge-pill badge-light border text-dark{% endif %} mr-2 mb-2 uf-badge" data-uf="{{ uf }}" style="cursor:pointer; {% if not selected_ufs or not uf in selected_ufs %}color:#000;{% endif %}">
                        {{ uf }}
                    </span>
                {% endfor %}
                <span id="uf-badge-all" class="{% if all_selected %}btn btn-sm btn-info rounded-pill{% else %}badge badge-pill badge-light border text-dark{% endif %} mr-2 mb-2" style="cursor:pointer; {% if not all_selected %}color:#000;{% endif %}">Todos</span>
                <button id="btn-apply" class="btn btn-primary ml-2">Atualizar</button>
            </div>
        </div>
    </div>

    {% if congressmen_ranking %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy text-warning"></i>
                        Ranking de Compatibilidade
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <style>
                            /* Watermark mosaic styles: repeated "<score> pontos" behind row content */
                            .score-row { position: relative; border-radius: 0.25rem; overflow: hidden; }
                            .score-mosaic {
                                position: absolute; inset: 0;
                                display: flex; flex-wrap: wrap; align-content: flex-start;
                                pointer-events: none; opacity: 0.15; font-weight: 700; color: #000; font-size: 1.5rem;
                            }
                            .score-mosaic .mosaic-item {
                                width: 160px; height: 64px;
                                display: flex; align-items: center; justify-content: center;
                                user-select: none;
                            }
                            .score-content { position: relative; z-index: 1; }
                        </style>
                        <table class="table table-striped table-hover mb-0" style="color: #000; --bs-table-hover-bg: #fffbe6;">
                            <tbody>
                                {# Agrupa todos os congressistas por pontuação (total_score) #}
                                {% regroup congressmen_ranking by total_score as score_groups %}
                                {% for score_group in score_groups %}
                                <tr>
                                    <td class="p-4 bg-light text-center">
                                        <strong><i>Ganharam {{ score_group.grouper }} pontos:</i></strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-3" style="position: relative;">
                                        <div class="score-row">
                                            <div class="score-mosaic">
                                                {% with reps_row="xxxxxxxx" reps_col="xxxxxxxxxxxx" %}
                                                    {% for _ in reps_row %}
                                                        {% for __ in reps_col %}
                                                            <span class="mosaic-item">{{ score_group.grouper }} pontos</span>
                                                        {% endfor %}
                                                    {% endfor %}
                                                {% endwith %}
                                            </div>
                                            <div class="score-content">
                                            {# Dentro desta pontuação, agrupamos por partido #}
{# Group by normalized party field to avoid duplicates (e.g., 'PT' vs 'pt' vs 'PT '). #}
{% regroup score_group.list by partido_norm as party_groups %}
                                            <div class="d-flex flex-wrap">
                                                {% for party_group in party_groups|sort_groups_by_size_and_name_desc %}
                                                    {# Card único por partido contendo todos os congressistas desse partido e dessa pontuação #}
                                                    <div class="card m-2 shadow-sm">
                                                        <div class="card-header">
                                                            <strong>{{ party_group.grouper }}</strong>
                                                        </div>
                                                        <div class="card-body">
                                                            {# Lista compacta com fotos menores (50x50) e nome, cada um linkado para a página de detalhes #}
                                                            <ul class="list-unstyled d-flex flex-wrap mb-0">
                                                                {% for congressman in party_group.list %}
                                                                    <li class="m-2">
                                                                        <a href="{% url 'voting:congressman_detail' congressman_id=congressman.id_cadastro %}"
                                                                           class="d-flex align-items-center text-decoration-none px-2 py-1">
                                                                            <img src="{{ congressman.get_foto_url }}"
                                                                                 alt="{{ congressman.nome }}"
                                                                                 class="rounded-circle"
                                                                                 style="width: 50px; height: 50px; object-fit: cover;"
                                                                                 onerror="this.src='https://via.placeholder.com/50x50?text=Foto'">
                                                                            <span class="ml-2 text-dark"><small><strong>{{ congressman.nome }}</strong></small></span>
                                                                        </a>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Pagination removed: showing all items as requested #}

    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <h4>Nenhum congressista encontrado</h4>
                {% if all_selected %}
                    <p>Não encontramos congressistas que tenham votado nas mesmas proposições que você.</p>
                {% else %}
                    <p>Não encontramos congressistas dos estados selecionados ({{ selected_ufs|join:", " }}) que tenham votado nas mesmas proposições que você.</p>
                {% endif %}
                <p>Isso pode acontecer se:</p>
                <ul class="text-left" style="display: inline-block;">
                    <li>Você ainda não votou em nenhuma proposição</li>
                    <li>Os congressistas do seu estado não votaram nas mesmas proposições</li>
                    <li>Os dados dos votos dos congressistas ainda não foram carregados</li>
                </ul>
                <a href="{% url 'voting:votacoes_disponiveis' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-vote-yea"></i> Ir para Votações Disponíveis
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    {% endif %}

    <!-- Simple JS to handle badge selection and update navigation -->
    <script>
        // Utility: read the initial selection from template variables
        const initialSelected = [{% for uf in selected_ufs %}'{{ uf }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        // Django templates do not support Python-style ternary; use an if-tag
        const isAllSelected = {% if all_selected %}true{% else %}false{% endif %};

        // Shared state for both initial prompt and header selector
        let selected = new Set(initialSelected);
        let allSel = isAllSelected;

        // Helper to refresh badge styles based on state
        function refreshStyles(containerId, allBadgeId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.querySelectorAll('.uf-badge').forEach(badge => {
                const uf = badge.getAttribute('data-uf');
                const selectedNow = allSel || selected.has(uf);
                // Reset classes for both selected and unselected states
                badge.classList.remove('badge','badge-pill','badge-light','border','text-dark','btn','btn-sm','btn-primary','rounded-pill');
                if (selectedNow) {
                    // Selected: look like a button
                    badge.classList.add('btn','btn-sm','btn-primary','rounded-pill');
                    badge.style.color = '';
                } else {
                    // Unselected: black text badge
                    badge.classList.add('badge','badge-pill','badge-light','border','text-dark');
                    badge.style.color = '#000';
                }
            });
            const allBadge = document.getElementById(allBadgeId);
            if (allBadge) {
                allBadge.classList.remove('badge','badge-pill','badge-light','border','text-dark','btn','btn-sm','btn-info','rounded-pill');
                if (allSel) {
                    allBadge.classList.add('btn','btn-sm','btn-info','rounded-pill');
                    allBadge.style.color = '';
                } else {
                    allBadge.classList.add('badge','badge-pill','badge-light','border','text-dark');
                    allBadge.style.color = '#000';
                }
            }
        }

        // Attach handlers for a given container
        function wireUp(containerId, allBadgeId, applyBtnId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            // Toggle individual UF
            container.querySelectorAll('.uf-badge').forEach(badge => {
                badge.addEventListener('click', () => {
                    const uf = badge.getAttribute('data-uf');
                    if (selected.has(uf)) {
                        selected.delete(uf);
                    } else {
                        selected.add(uf);
                    }
                    // Turning off "Todos" if a specific toggle happens
                    allSel = false;
                    refreshStyles(containerId, allBadgeId);
                });
            });
            // Toggle "Todos"
            const allBadge = document.getElementById(allBadgeId);
            if (allBadge) {
                allBadge.addEventListener('click', () => {
                    allSel = !allSel;
                    if (allSel) {
                        // When selecting all, ensure all UFs are marked selected visually
                        selected = new Set();
                    }
                    refreshStyles(containerId, allBadgeId);
                });
            }
            // Apply selection and reload page
            const applyBtn = document.getElementById(applyBtnId);
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    const basePath = window.location.pathname;
                    let parts = [];
                    if (allSel) {
                        parts.push('all=1');
                    } else {
                        selected.forEach(uf => parts.push(`ufs=${encodeURIComponent(uf)}`));
                    }
                    const qs = parts.join('&');
                    const url = qs ? `${basePath}?${qs}` : basePath;
                    window.location.href = url;
                });
            }
            refreshStyles(containerId, allBadgeId);
        }

        // Wire both the initial prompt and the header selector (if present)
        wireUp('uf-badges', 'uf-badge-all', 'btn-apply');
        wireUp('uf-badges-initial', 'uf-badge-all-initial', 'btn-apply-initial');
    </script>

    <!-- Information section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle text-info"></i>
                        Como funciona o ranking personalizado?
                    </h5>
                    <p class="card-text">
                        Este ranking mostra os congressistas dos estados selecionados, ordenados pela compatibilidade com seus votos.
                        A pontuação é calculada comparando como você votou com o voto do congressista nas mesmas proposições.
                    </p>
                    <ul>
                        <li><strong>Pontos:</strong>Número de votações em que vocês votaram igual. Considera a importância que você atribuiu a cada votação.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}