## Windows production-like Docker Compose stack for VoteBem
## - Runs the full application (MariaDB, Valkey, Django/Gunicorn, Nginx) on Docker Desktop
## - Mirrors the Linux production `docker-compose.yml` but maps all host paths
##   under a configurable DATA_ROOT directory on Windows (e.g. C:\votebem_data)
## - Exposes:
##     - MariaDB only on localhost:3306 for security
##     - Django app on localhost:8001 (consumed only by the Nginx container)
##     - Nginx on port 80 to serve static/media files and reverseâ€‘proxy the app
## - Uses an external `vps_network` so this stack can coexist with other
##   infrastructure services that share the same Docker network name.
## - Redundancy: keep this file; it is the canonical Windows Docker stack and
##   is used/generated by the Windows deployment scripts.

services:
  db:
    image: mariadb:11
    container_name: votebem_db
    environment:
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - ${DATA_ROOT}/mariadb/votebem/data:/var/lib/mysql
      - ${DATA_ROOT}/mariadb/votebem/backups:/backups
    ports:
      - "127.0.0.1:3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mariadb -h 127.0.0.1 -uroot -p$${MARIADB_ROOT_PASSWORD} -e 'SELECT 1' >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    networks:
      - vps_network

  valkey:
    image: valkey/valkey:7-alpine
    container_name: votebem_valkey
    volumes:
      - ${DATA_ROOT}/valkey/votebem/data:/data
    restart: unless-stopped
    networks:
      - vps_network

  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: votebem-web:latest
    pull_policy: never
    container_name: votebem-web
    restart: unless-stopped
    environment:
      DJANGO_ENV_PATH: /dados/votebem/.env
      REDIS_URL: redis://valkey:6379/0
    env_file: .env
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - ${DATA_ROOT}/nginx/app/votebem/static:/app/staticfiles
      - ${DATA_ROOT}/votebem/votebem/media:/app/media
      - ${DATA_ROOT}/votebem/logs:/app/logs
      - ${DATA_ROOT}/votebem/.env:/app/votebem/.env:ro
      - ${DATA_ROOT}/votebem:/dados/votebem
      - ${DATA_ROOT}/embeddings:/dados/embeddings
      - ${DATA_ROOT}/chroma:/dados/chroma
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_started
    command: >
      sh -c "set -e;
             mkdir -p /dados/votebem/docs/noticias;
             python manage.py migrate --settings=votebem.settings.production;
             python manage.py collectstatic --noinput --settings=votebem.settings.production;
             gunicorn --bind 0.0.0.0:8000 --workers 3 --timeout 60 votebem.wsgi:application"
    networks:
      - vps_network

  nginx:
    image: nginx:alpine
    container_name: votebem_nginx
    ports:
      - "80:80"
    volumes:
      - ${DATA_ROOT}/nginx/conf.d:/etc/nginx/conf.d
      - ${DATA_ROOT}/nginx/app/votebem/static:/app/staticfiles:ro
      - ${DATA_ROOT}/votebem/votebem/media:/app/media:ro
    depends_on:
      - web
    networks:
      - vps_network

networks:
  vps_network:
    external: true
    name: vps_network
