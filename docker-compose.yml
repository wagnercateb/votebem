services:
  # MariaDB database service
  db:
    image: mariadb:11
    container_name: votebem_db
    environment:
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - /dados/mariadb/votebem/data:/var/lib/mysql
      - /dados/mariadb/votebem/backups:/backups
    ports:
      - "127.0.0.1:3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mariadb -h 127.0.0.1 -uroot -p$${MARIADB_ROOT_PASSWORD} -e 'SELECT 1' >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    networks:
      - vps_network

  # Valkey (Redis-compatible) cache/datastore
  valkey:
    image: valkey/valkey:7-alpine
    container_name: votebem_valkey
    volumes:
      - /dados/valkey/votebem/data:/data
    restart: unless-stopped
    networks:
      - vps_network

  # Django application served by Gunicorn
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: votebem-web:latest
    pull_policy: never
    container_name: votebem-web
    restart: unless-stopped
    # Ensure the application receives all variables from .env.
    # Avoid hardcoding DB/Redis here; let .env drive values to prevent socket fallback.
    env_file: .env
    # Publish container port 8000 to host 127.0.0.1:8001 for nginx proxy
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - /dados/nginx/app/votebem/static:/app/staticfiles
      - /dados/votebem/votebem/media:/app/media
      - /dados/votebem/logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_started
    command: >
      sh -c "python manage.py migrate --settings=votebem.settings.production &&
             python manage.py collectstatic --noinput --settings=votebem.settings.production &&
             gunicorn --bind 0.0.0.0:8000 --workers 3 --timeout 60 votebem.wsgi:application"
    networks:
      - vps_network

networks:
  vps_network:
    external: true
    name: vps_network
