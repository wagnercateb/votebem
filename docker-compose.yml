## Linux production Docker Compose stack for VoteBem
## - Runs the MariaDB database, Valkey (Redis‑compatible cache) and the Django
##   application served by Gunicorn.
## - All persistent data and configuration live under /dados on the host so that
##   database files, media uploads, logs and embeddings survive container rebuilds.
## - The `web` service builds from the project Dockerfile, runs migrations,
##   collects static assets and then starts Gunicorn bound to port 8000.
## - The application listens on 127.0.0.1:8001 on the host, normally consumed
##   by a separate host‑level Nginx that terminates HTTP and serves static/media.
## - The external `vps_network` allows this stack to communicate with other
##   infrastructure containers that share the same network name.
## - Redundancy: this is the canonical Linux production stack; do not remove it
##   unless the production deployment strategy itself is being replaced.

# After changing docker-compose.yml , use docker compose up -d to recreate the container. docker compose restart web does not apply changed environment or volume configuration.
services:
  # MariaDB database service
  db:
    image: mariadb:11
    container_name: votebem_db
    environment:
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - /dados/mariadb/votebem/data:/var/lib/mysql
      - /dados/mariadb/votebem/backups:/backups
    ports:
      - "127.0.0.1:3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mariadb -h 127.0.0.1 -uroot -p$${MARIADB_ROOT_PASSWORD} -e 'SELECT 1' >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    networks:
      - vps_network

  # Valkey (Redis-compatible) cache/datastore
  valkey:
    image: valkey/valkey:7-alpine
    container_name: votebem_valkey
    volumes:
      - /dados/valkey/votebem/data:/data
    restart: unless-stopped
    networks:
      - vps_network

  # Django application served by Gunicorn
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: votebem-web:latest
    pull_policy: never
    container_name: votebem-web
    restart: unless-stopped
    #The app chooses the env file path from DJANGO_ENV_PATH or falls back to /app/votebem/.env ( votebem/settings/production.py:9 )
    # If the file lives on the host and is not already inside the container, you must bind‑mount it with volumes: - /dados/votebem/.env:/app/votebem/.env:ro (or mount it at /dados/votebem/.env ) so the app can read it
    environment:
      DJANGO_ENV_PATH: /dados/votebem/.env
      REDIS_URL: redis://valkey:6379/0
    # Ensure the application receives all variables from .env.
    # Avoid hardcoding DB/Redis here; let .env drive values to prevent socket fallback.
    env_file: .env
    # Publish container port 8000 to host 127.0.0.1:8001 for nginx proxy
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - /dados/nginx/app/votebem/static:/app/staticfiles
      - /dados/votebem/votebem/media:/app/media
      - /dados/votebem/logs:/app/logs
      - /dados/votebem/.env:/app/votebem/.env:ro
      - /dados/votebem:/dados/votebem
      # Mount embeddings root so the app can write file_hashes.npy to /dados/embeddings/votebem
      - /dados/embeddings:/dados/embeddings
      - /dados/chroma:/dados/chroma
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_started
    command: >
      sh -c "set -e;
             mkdir -p /dados/votebem/docs/noticias;
             python manage.py migrate --settings=votebem.settings.production;
             python manage.py collectstatic --noinput --settings=votebem.settings.production;
             gunicorn --bind 0.0.0.0:8000 --workers 3 --timeout 60 votebem.wsgi:application"
    networks:
      - vps_network

networks:
  vps_network:
    external: true
    name: vps_network
